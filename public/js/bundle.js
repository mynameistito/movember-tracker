var G={};var Rt="https://{subdomain}.movember.com/donate/details",bt="https://{subdomain}.movember.com/team/{id}",Ot="14810348";var U=[1e3,2e3,4e3],vt={uk:"GBP",au:"AUD",us:"USD",ca:"CAD",nz:"NZD",ie:"EUR",za:"ZAR",nl:"EUR",de:"EUR",fr:"EUR",es:"EUR",it:"EUR",ex:"EUR",cz:"CZK",dk:"DKK",se:"SEK"};function $t(t){return t&&vt[t.toLowerCase()]||"AUD"}var It={USD:"$",AUD:"$",CAD:"$",NZD:"$",GBP:"\xA3",EUR:"\u20AC",JPY:"\xA5",ZAR:"R",CZK:"K\u010D",DKK:"kr",SEK:"kr"};function nt(t){return t&&It[t.toUpperCase()]||"$"}function Ct(){return`${window.location.origin}/proxy`}var w=t=>{let r=Math.round(t/1e3),e=Math.floor(r/60),n=r%60;return e>0?`${e}m ${n}s (${t}ms)`:`${r}s (${t}ms)`},at=t=>new Promise(r=>setTimeout(r,t));var x={DEBUG:0,INFO:1,WARN:2,ERROR:3,NONE:4},B=x.INFO;function Ht(){try{let r=localStorage.getItem("LOG_LEVEL");if(r){let e=r.toUpperCase();if(e in x){B=x[e];return}}}catch(r){typeof console<"u"&&console.warn&&console.warn("[LOGGER] localStorage unavailable, using default log level:",r instanceof Error?r.message:String(r))}B=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"||window.location.search.includes("debug=true")?x.DEBUG:x.INFO}Ht();function z(t,r,...e){return[`[${new Date().toISOString()}] [${t}] ${r}`,...e]}function Z(t){return x[t]>=B}var Tt={setLevel(t){let r=t.toUpperCase();if(r in x){B=x[r];try{localStorage.setItem("LOG_LEVEL",r)}catch(e){try{Tt.warn("[LOGGER]","Failed to persist log level to localStorage:",e instanceof Error?e.message:String(e))}catch{typeof console<"u"&&console.warn&&console.warn("[LOGGER] Failed to persist log level:",e instanceof Error?e.message:String(e))}}}},getLevel(){for(let[t,r]of Object.entries(x))if(r===B)return t;return"INFO"},debug(t,...r){Z("DEBUG")&&console.debug(...z("DEBUG",t,...r))},info(t,...r){Z("INFO")&&console.log(...z("INFO",t,...r))},warn(t,...r){Z("WARN")&&console.warn(...z("WARN",t,...r))},error(t,...r){Z("ERROR")&&console.error(...z("ERROR",t,...r))}},o=Tt;var K=(t,r)=>{let e=t.trim(),n=r?$t(r):"AUD",a=e.replace(/[$€£¥]|\b(USD|EUR|GBP|AUD|JPY|CAD|NZD|ZAR)\b/gi,"").trim().match(/[\d,]+\.?\d*/);return{value:a?a[0]:"0",currency:n}},f=t=>{if(!t||typeof t!="string")return!1;let r=t.replace(/[,.\s$€£¥]/g,"");return!(!r||r.length===0||!/^\d+$/.test(r)||!/\d/.test(t)||/^[,.\s$€£¥]+$/.test(t))},ot=(t,r)=>{let e=parseFloat(t.replace(/,/g,"")),n=parseFloat(r.replace(/,/g,""));return n===0?0:Math.round(e/n*100)};var Dt={SUBDOMAIN:/https?:\/\/([^.]+)\.movember\.com/},C=[/\bGBP\b[\s:]*[\d,]+|[\d,]+[\s:]*\bGBP\b|British\s+Pound/i,/\bEUR\b[\s:]*[\d,]+|[\d,]+[\s:]*\bEUR\b|Euro[\s:]*[\d,]+/i,/\bUSD\b[\s:]*[\d,]+|[\d,]+[\s:]*\bUSD\b|US\s+Dollar/i,/\bAUD\b[\s:]*[\d,]+|[\d,]+[\s:]*\bAUD\b|Australian\s+Dollar/i,/\bCAD\b[\s:]*[\d,]+|[\d,]+[\s:]*\bCAD\b|Canadian\s+Dollar/i,/\bNZD\b[\s:]*[\d,]+|[\d,]+[\s:]*\bNZD\b|New\s+Zealand\s+Dollar/i,/\bZAR\b[\s:]*[\d,]+|[\d,]+[\s:]*\bZAR\b|South\s+African\s+Rand/i,/\bCZK\b[\s:]*[\d,]+|[\d,]+[\s:]*\bCZK\b|Czech\s+Koruna|Kč[\d,]+/i,/\bSEK\b[\s:]*[\d,]+|[\d,]+[\s:]*\bSEK\b|Swedish\s+Krona/i,/\bDKK\b[\s:]*[\d,]+|[\d,]+[\s:]*\bDKK\b|Danish\s+Krone/i],R={IRELAND:/Ireland|Irish/i,NETHERLANDS:/Netherlands|Dutch/i,GERMANY:/Germany|German/i,FRANCE:/France|French/i,SPAIN:/Spain|Spanish/i,ITALY:/Italy|Italian/i,UNITED_STATES:/United\s+States|US\s+Dollar/i,CANADA:/Canada|Canadian/i,NEW_ZEALAND:/New\s+Zealand/i,AUSTRALIA:/Australia|Australian/i},yt=/\$[\d,]+/,it=[/"AmountRaised"[^}]*"(?:convertedAmount|originalAmount)"["\s:]*["']([\d,]+(?:\.\d+)?)/i,/donationProgress--amount__raised[^>]*>([^<]*\$([\d,]+(?:\.\d+)?)[^<]*)/i,/class="[^"]*donationProgress--amount__raised[^"]*"[^>]*>[\s\S]*?\$([\d,]+(?:\.\d+)?)/i,/"(?:raised|raisedAmount|currentAmount)"[:\s]*["']?\$?([\d,]+(?:\.\d+)?)/i,/data-(?:raised|amount)=["']?\$?([\d,]+(?:\.\d+)?)/i,/donationProgress--amount__raised[^>]*>([^<]*[€£$]([\d,]+(?:\.\d+)?)[^<]*)/i,/donationProgress--amount__raised[^>]*>([^<]*(?:USD|EUR|GBP|AUD)\s*([\d,]+(?:\.\d+)?)[^<]*)/i],st=[/"target"[^}]*"fundraising"[^}]*"value"["\s:]*["']([\d,]+(?:\.\d+)?)/i,/donationProgress--amount__target[^>]*>([^<]*\$([\d,]+(?:\.\d+)?)[^<]*)/i,/class="[^"]*donationProgress--amount__target[^"]*"[^>]*>[\s\S]*?\$([\d,]+(?:\.\d+)?)/i,/"(?:target|targetAmount|goal)"[:\s]*["']?\$?([\d,]+(?:\.\d+)?)/i,/data-(?:target|goal)=["']?\$?([\d,]+(?:\.\d+)?)/i,/donationProgress--amount__target[^>]*>([^<]*[€£$]([\d,]+(?:\.\d+)?)[^<]*)/i,/donationProgress--amount__target[^>]*>([^<]*(?:USD|EUR|GBP|AUD)\s*([\d,]+(?:\.\d+)?)[^<]*)/i],Y=[/"AmountRaised"[^}]*"(?:convertedAmount|originalAmount)"["\s:]*["']([\d,]+(?:\.\d+)?)/i,/"(?:raised|raisedAmount|currentAmount|donationAmount|amount)"[:\s]*["']?\$?([\d,]+(?:\.\d+)?)/i,/raised[:\s]*["']?\$?([\d,]+(?:\.\d+)?)/i],V=[/"target"[^}]*"fundraising"[^}]*"value"["\s:]*["']([\d,]+(?:\.\d+)?)/i,/"(?:target|targetAmount|goal)"[:\s]*["']?\$?([\d,]+(?:\.\d+)?)/i,/(?:target|goal)[:\s]*["']?\$?([\d,]+(?:\.\d+)?)/i],ct=[/\$([\d,]+(?:\.\d+)?)\s*(?:raised|donated|collected)/i,/(?:raised|donated|collected)[:\s]*\$([\d,]+(?:\.\d+)?)/i,/<[^>]+class="[^"]*(?:amount|raised|donation|progress)[^"]*"[^>]*>\s*\$?([\d,]+(?:\.\d+)?)/i,/data-[^=]*amount[^=]*=["']?\$?([\d,]+(?:\.\d+)?)/i,/\$([\d,]+(?:\.\d+)?)\s*(?:of|out of)/i,/raised[:\s=]+[$]?([\d,]+(?:\.\d+)?)/i,/amount[:\s=]+[$]?([\d,]+(?:\.\d+)?)/i],ut=[/\$([\d,]+(?:\.\d+)?)\s*(?:target|goal)/i,/(?:target|goal)[:\s]*\$([\d,]+(?:\.\d+)?)/i,/<[^>]+class="[^"]*(?:target|goal)[^"]*"[^>]*>\s*\$?([\d,]+(?:\.\d+)?)/i,/data-[^=]*(?:target|goal)[^=]*=["']?\$?([\d,]+(?:\.\d+)?)/i,/\$([\d,]+(?:\.\d+)?)\s*(?:of|out of)\s*\$([\d,]+(?:\.\d+)?)/i,/target[:\s=]+[$]?([\d,]+(?:\.\d+)?)/i,/goal[:\s=]+[$]?([\d,]+(?:\.\d+)?)/i];function Ft(t){try{let e=new DOMParser().parseFromString(t,"text/html"),n=["h1.mospace-heroarea--donations-target-amount-number",'h1[class*="mospace-heroarea--donations-target-amount-number"]',"span.donationProgress--amount__raised","span[class*='donationProgress--amount__raised']",".donationProgress--amount__raised",'[class*="donationProgress--amount__raised"]','[class*="raised"]',"[data-raised]","[data-amount]","[data-raised-amount]"];for(let a of n){let s=e.querySelectorAll(a);for(let c of Array.from(s)){let d=(c.textContent||c.innerText||"").match(/[\d,]+(?:\.\d+)?/);if(d&&f(d[0]))return o.info("[SCRAPE]",`Found raised amount using DOMParser with selector "${a}": ${d[0]}`),d[0];let u=c.getAttribute("data-raised")||c.getAttribute("data-amount")||c.getAttribute("data-raised-amount");if(u&&f(u))return o.info("[SCRAPE]",`Found raised amount using DOMParser data attribute: ${u}`),u}}let i=e.querySelectorAll("script");for(let a of Array.from(i)){let s=a.textContent||a.innerHTML||"";for(let c=0;c<Y.length;c++){let g=Y[c],d=s.match(g);if(d){let u=d[1];if(f(u))return o.info("[SCRAPE]",`Found raised amount in JSON using DOMParser: ${u}`),u}}}}catch(r){o.warn("[SCRAPE]","DOMParser extraction failed, falling back to regex:",r)}return""}function wt(t){let r=Ft(t);if(r)return r;o.info("[SCRAPE]","DOMParser didn't find raised amount, trying regex patterns..."),r="";for(let e=0;e<it.length;e++){let n=it[e],i=t.match(n);if(i){let a=i[i.length-1];if((!a||!f(a))&&i.length>2&&(a=i[i.length-2]),o.debug("[SCRAPE]",`Pattern ${e+1} matched, all groups:`,i.slice(1),`using: "${a}"`),f(a)){r=a,o.info("[SCRAPE]",`Found valid raised amount using pattern ${e+1}: ${r}`);break}else o.warn("[SCRAPE]",`Pattern ${e+1} matched but invalid number: "${a}", trying next pattern...`)}}if(!r){o.info("[SCRAPE]","Checking for JSON data in script tags...");let e=t.match(/<script[^>]*>([\s\S]*?)<\/script>/gi);if(e)for(let n of e){for(let i=0;i<Y.length;i++){let a=Y[i],s=n.match(a);if(s){let c=s[1];if(f(c)){r=c,o.info("[SCRAPE]",`Found valid raised amount in JSON using pattern ${i+1}: ${r}`);break}else o.warn("[SCRAPE]",`JSON raised pattern ${i+1} matched but invalid number: "${c}"`)}}if(r)break}}if(!r){o.info("[SCRAPE]","Trying generic dollar amount patterns as last resort...");for(let e=0;e<ct.length;e++){let n=ct[e],i=t.match(n);if(i){let a=i[1];if(f(a)){r=a,o.info("[SCRAPE]",`Found valid raised amount using generic pattern ${e+1}: ${r}`);break}else o.warn("[SCRAPE]",`Generic pattern ${e+1} matched but invalid number: "${a}"`)}}}if(!r){o.info("[SCRAPE]","Performing aggressive context-based search...");let e=[...t.matchAll(/\$([\d,]+(?:\.\d+)?)/g)];if(o.debug("[SCRAPE]",`Found ${e.length} dollar amounts in HTML`),e.length>0){let n=[];for(let i of e){let a=i[1];if(!f(a))continue;let s=i.index??0,c=Math.max(0,s-300),g=Math.min(t.length,s+i[0].length+300),d=t.substring(c,g).toLowerCase(),u=0;/(?:raised|donated|collected|current|funds?|progress|amount\s*(?:raised|donated))/i.test(d)&&(u+=10),/(?:has\s+raised|has\s+donated|has\s+collected|currently\s+raised)/i.test(d)&&(u+=5),/\$[\d,]+(?:\.\d+)?\s*(?:raised|donated|collected)/i.test(d)&&(u+=8),u>0&&n.push({amount:a,score:u,raisedScore:u,context:d.substring(0,200)})}if(n.sort((i,a)=>a.raisedScore-i.raisedScore),n.length>0){let i=n.filter(a=>a.raisedScore>0).sort((a,s)=>s.raisedScore-a.raisedScore);i.length>0&&(r=i[0].amount,o.info("[SCRAPE]",`Found raised amount via context search: ${r} (raisedScore: ${i[0].raisedScore})`))}}}return r}function kt(t){try{let e=new DOMParser().parseFromString(t,"text/html"),n=["div#mospace-heroarea--donations-target-text",'div[id*="mospace-heroarea--donations-target-text"]',"span.donationProgress--amount__target","span[class*='donationProgress--amount__target']",".donationProgress--amount__target",'[class*="donationProgress--amount__target"]','[class*="target"]','[class*="goal"]',"[data-target]","[data-goal]","[data-target-amount]"];for(let a of n){let s=e.querySelectorAll(a);for(let c of Array.from(s)){let d=(c.textContent||c.innerText||"").match(/[\d,]+(?:\.\d+)?/);if(d&&f(d[0]))return o.info("[SCRAPE]",`Found target amount using DOMParser with selector "${a}": ${d[0]}`),d[0];let u=c.getAttribute("data-target")||c.getAttribute("data-goal")||c.getAttribute("data-target-amount");if(u&&f(u))return o.info("[SCRAPE]",`Found target amount using DOMParser data attribute: ${u}`),u}}let i=e.querySelectorAll("script");for(let a of Array.from(i)){let s=a.textContent||a.innerHTML||"";for(let c=0;c<V.length;c++){let g=V[c],d=s.match(g);if(d){let u=d[1];if(f(u))return o.info("[SCRAPE]",`Found target amount in JSON using DOMParser: ${u}`),u}}}}catch(r){o.warn("[SCRAPE]","DOMParser extraction failed, falling back to regex:",r)}return""}function xt(t){let r=kt(t);if(r)return r;o.info("[SCRAPE]","DOMParser didn't find target amount, trying regex patterns..."),r="";for(let e=0;e<st.length;e++){let n=st[e],i=t.match(n);if(i){let a=i[i.length-1];if((!a||!f(a))&&i.length>2&&(a=i[i.length-2]),o.debug("[SCRAPE]",`Target pattern ${e+1} matched, all groups:`,i.slice(1),`using: "${a}"`),f(a)){r=a,o.info("[SCRAPE]",`Found valid target amount using pattern ${e+1}: ${r}`);break}else o.warn("[SCRAPE]",`Target pattern ${e+1} matched but invalid number: "${a}", trying next pattern...`)}}if(!r){let e=t.match(/<script[^>]*>([\s\S]*?)<\/script>/gi);if(e)for(let n of e){for(let i=0;i<V.length;i++){let a=V[i],s=n.match(a);if(s){let c=s[1];if(f(c)){r=c,o.info("[SCRAPE]",`Found valid target amount in JSON using pattern ${i+1}: ${r}`);break}else o.warn("[SCRAPE]",`JSON target pattern ${i+1} matched but invalid number: "${c}"`)}}if(r)break}}if(!r){o.info("[SCRAPE]","Trying generic target amount patterns as last resort...");for(let e=0;e<ut.length;e++){let n=ut[e],i=t.match(n);if(i){let a=null;for(let s=i.length-1;s>=1;s--)if(i[s]&&f(i[s])){a=i[s];break}if(a){r=a,o.info("[SCRAPE]",`Found valid target amount using generic pattern ${e+1}: ${r}`);break}else o.warn("[SCRAPE]",`Generic target pattern ${e+1} matched but no valid number found in capture groups`)}}}if(!r){let e=[...t.matchAll(/\$([\d,]+(?:\.\d+)?)/g)];if(e.length>0){let n=[];for(let i of e){let a=i[1];if(!f(a))continue;let s=i.index??0,c=Math.max(0,s-300),g=Math.min(t.length,s+i[0].length+300),d=t.substring(c,g).toLowerCase(),u=0;/(?:target|goal|aim|objective|of\s+\$)/i.test(d)&&(u+=10),/(?:target\s+(?:of|is)|goal\s+(?:of|is)|aim\s+(?:of|is))/i.test(d)&&(u+=5),/\$[\d,]+(?:\.\d+)?\s*(?:target|goal)/i.test(d)&&(u+=8),u>0&&n.push({amount:a,score:u,targetScore:u,context:d.substring(0,200)})}if(n.sort((i,a)=>a.targetScore-i.targetScore),n.length>0){let i=n.filter(a=>a.targetScore>0).sort((a,s)=>s.targetScore-a.targetScore);i.length>0&&(r=i[0].amount,o.info("[SCRAPE]",`Found target amount via context search: ${r} (targetScore: ${i[0].targetScore})`))}}}return r}function W(t,r,e){let n=Date.now();o.info("[SCRAPE]","Extracting data from HTML...");let i=wt(t),a=xt(t),s=Date.now()-n;return o.info("[SCRAPE]",`Data extraction completed in ${w(s)}`),o.debug("[SCRAPE]",`Raw extracted data for memberId ${r} (subdomain: ${e}):`,{raised:i||"NOT FOUND",target:a||"NOT FOUND"}),{raised:i,target:a}}var q={LOW:"low",MEDIUM:"medium",HIGH:"high",CRITICAL:"critical"},j={SCRAPING:"scraping",SUBDOMAIN:"subdomain",CACHE:"cache",NETWORK:"network",PARSING:"parsing",VALIDATION:"validation",UNKNOWN:"unknown"},_={MAX_ERRORS:50,TTL_DAYS:7,MESSAGE_MAX_LENGTH:200,STACK_MAX_LENGTH:500},Gt=new Set(["token","access_token","refresh_token","api_key","apikey","password","secret","auth","authorization","session","sessionid","sid","csrf","csrf_token","email","user","username","memberid","member_id"]),Mt=new Set([]),Bt=[/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g,/\b(?:token|api[_-]?key|access[_-]?token|refresh[_-]?token|auth[_-]?token|bearer)\s*[:=]\s*['"]?([A-Za-z0-9\-._~+/]+=*)['"]?/gi,/\b(?:password|passwd|pwd|secret)\s*[:=]\s*['"]?([^\s'"]+)['"]?/gi,/\b\d{4}[\s-]?\d{4}[\s-]?\d{4}[\s-]?\d{4}\b/g];function X(t){if(!t)return"";let r=2166136261;for(let e=0;e<t.length;e++)r^=t.charCodeAt(e),r+=(r<<1)+(r<<4)+(r<<7)+(r<<8)+(r<<24);return`hash_${Math.abs(r).toString(16).substring(0,16)}`}function dt(t){let r=t;for(let e of Bt)r=r.replace(e,"[REDACTED]");return r}function Kt(t){let r=dt(t),e=r.length>_.MESSAGE_MAX_LENGTH?`${r.substring(0,_.MESSAGE_MAX_LENGTH)}...`:r,i=r!==t||e!==r?X(t):void 0;return{message:e,hash:i}}function Yt(t){if(!t)return{};let r=dt(t),e=r.length>_.STACK_MAX_LENGTH?`${r.substring(0,_.STACK_MAX_LENGTH)}...`:r,i=r!==t||e!==r?X(t):void 0;return{stack:e,hash:i}}function Vt(t){if(t)try{let r=new URL(t),e=r.origin,n=r.pathname;if(Mt.size===0)return`${e}${n}`;let i=new URLSearchParams;r.searchParams.forEach((s,c)=>{let g=c.toLowerCase();Mt.has(g)&&!Gt.has(g)&&i.set(c,s)});let a=i.toString();return a?`${e}${n}?${a}`:`${e}${n}`}catch{let e=t.split("#")[0].split("?")[0];try{let n=new URL(e);return`${n.origin}${n.pathname}`}catch{return"[INVALID_URL]"}}}function Jt(t){let r=Date.now();return t.filter(e=>{if(!e.expiresAt)return!0;try{return new Date(e.expiresAt).getTime()>r}catch{return!1}})}function zt(t){return t.length<=_.MAX_ERRORS?t:t.slice(-_.MAX_ERRORS)}function lt(t,r={}){let e=t instanceof Error?t.message:String(t),n=t instanceof Error?t.stack:void 0,{message:i,hash:a}=Kt(e),{stack:s,hash:c}=Yt(n),g=new Date,d=new Date(g.getTime()+_.TTL_DAYS*24*60*60*1e3),u={timestamp:g.toISOString(),expiresAt:d.toISOString(),message:i,...a&&{messageHash:a},...s&&{stack:s},...c&&{stackHash:c},category:r.category||j.UNKNOWN,severity:r.severity||q.MEDIUM,context:{...r.memberId&&{memberId:X(r.memberId)},...r.subdomain&&{subdomain:X(r.subdomain)},...r.url&&{url:Vt(r.url)},...r.metadata&&Object.keys(r.metadata).length>0&&{metadata:Object.fromEntries(Object.entries(r.metadata).map(([l,h])=>[l,typeof h=="string"?dt(h):h]))}}};o.error("[ERROR_TRACKING]",`[${u.category}] [${u.severity}] ${e}`,u);try{let l=JSON.parse(localStorage.getItem("error_tracking_log")||"[]"),h=Jt(l);h.push(u);let b=zt(h);localStorage.setItem("error_tracking_log",JSON.stringify(b))}catch(l){if(o?.warn)try{o.warn("[ERROR_TRACKING]","Failed to store error in localStorage (quota exceeded or unavailable):",l instanceof Error?l.message:String(l))}catch{}}return u}function mt(t,r={}){return lt(t,{category:j.SCRAPING,severity:q.HIGH,...r})}function gt(t,r={}){return lt(t,{category:j.SUBDOMAIN,severity:q.MEDIUM,...r})}function Pt(t,r={}){return lt(t,{category:j.NETWORK,severity:q.HIGH,...r})}function M(t){let r=t.match(Dt.SUBDOMAIN);return r?r[1]:null}async function T(t){let r=`${Ct()}?url=${encodeURIComponent(t)}`,e=await fetch(r);if(!e.ok){let a=`Proxy error! status: ${e.status}`;try{if(e.headers.get("content-type")?.includes("application/json")){let g=await e.json();g.message&&(a=g.message)}else{let g=await e.text();g&&(a=g.substring(0,200))}}catch(c){o.warn("[PROXY]","Could not parse error response:",c)}let s=new Error(a);throw Pt(s,{url:t,metadata:{status:e.status,statusText:e.statusText}}),s}let n=await e.text(),i=e.headers.get("X-Final-URL")||t;return{html:n,finalUrl:i}}function L(t,r){return`${Rt.replace("{subdomain}",r)}?memberId=${t}`}function v(t,r){return bt.replace("{subdomain}",r).replace("{id}",t)}function P(t,r,e){return`movember:${e}:${t}:${r}`}function ft(t,r){try{let e=P(t,r,"data"),n=localStorage.getItem(e);if(!n)return null;let i=JSON.parse(n);return Date.now()-i.cachedAt>i.ttl?(localStorage.removeItem(e),null):i.data}catch(e){return o.warn("[CACHE]","Error reading cached data:",e),null}}function Et(t,r){try{let e=P(t,r,"data"),n=localStorage.getItem(e);return n?JSON.parse(n).data:null}catch(e){return o.warn("[CACHE]","Error reading stale cached data:",e),null}}function St(t,r){try{let e=P(t,r,"data"),n=localStorage.getItem(e);if(!n)return!1;let i=JSON.parse(n);return Date.now()-i.cachedAt>i.ttl}catch(e){return o.warn("[CACHE]","Error checking if cached data is stale:",e),!1}}function O(t,r,e,n){try{let i=P(t,r,"data"),a={data:e,cachedAt:Date.now(),ttl:n};localStorage.setItem(i,JSON.stringify(a))}catch(i){o.warn("[CACHE]","Error setting cached data:",i)}}function ht(t,r){try{let e=P(t,r,"subdomain"),n=localStorage.getItem(e);if(!n)return null;let i=JSON.parse(n);return Date.now()-i.cachedAt>i.ttl?(localStorage.removeItem(e),null):i.subdomain}catch(e){return o.warn("[CACHE]","Error reading cached subdomain:",e),null}}function S(t,r,e,n){try{let i=P(t,r,"subdomain"),a={subdomain:e,cachedAt:Date.now(),ttl:n};localStorage.setItem(i,JSON.stringify(a))}catch(i){o.warn("[CACHE]","Error setting cached subdomain:",i)}}function J(t,r){try{let e=P(t,r,"data");localStorage.removeItem(e);let n=P(t,r,"subdomain");localStorage.removeItem(n);let i=`movember:amount:${t}:${r}`;localStorage.removeItem(i)}catch(e){o.warn("[CACHE]","Error clearing cached data:",e)}}function I(t){return t?t.includes("\xA3")||t.includes("&pound;")||t.includes("&#163;")?"uk":t.includes("\u20AC")||t.includes("&euro;")||t.includes("&#8364;")?t.match(R.IRELAND)?"ie":t.match(R.NETHERLANDS)?"nl":t.match(R.GERMANY)?"de":t.match(R.FRANCE)?"fr":t.match(R.SPAIN)?"es":t.match(R.ITALY)?"it":"ie":C[0].test(t)?"uk":C[1].test(t)?t.match(R.IRELAND)?"ie":t.match(R.NETHERLANDS)?"nl":t.match(R.GERMANY)?"de":t.match(R.FRANCE)?"fr":t.match(R.SPAIN)?"es":t.match(R.ITALY)?"it":"ie":C[2].test(t)?"us":C[3].test(t)?"au":C[4].test(t)?"ca":C[5].test(t)?"nz":C[6].test(t)?"za":C[7].test(t)?"cz":C[8].test(t)?"se":C[9].test(t)?"dk":yt.test(t)?t.match(R.UNITED_STATES)?"us":t.match(R.CANADA)?"ca":t.match(R.NEW_ZEALAND)?"nz":(t.match(R.AUSTRALIA),"au"):null:null}async function Q(t,r=!1){if(r)o.info("[SUBDOMAIN]",`Force refresh requested, skipping cache for memberId ${t}`);else{let n=ht("member",t);if(n)return o.info("[SUBDOMAIN]",`Found cached subdomain for memberId ${t}: ${n}`),n}if(G[t]){let n=G[t];return o.info("[SUBDOMAIN]",`Using manual override for memberId ${t}: ${n}`),S("member",t,n,864e5),n}o.info("[SUBDOMAIN]",`Detecting subdomain for memberId ${t}...`);let e=["au","uk","us","ca","nz","ie","za","nl","de","fr","es","it","cz","dk","se","ex"];try{let n=null;for(let a of e){let s=L(t,a);try{let{html:c,finalUrl:g}=await T(s),d=M(g);if(d&&d!==a)return o.info("[SUBDOMAIN]",`URL redirected from ${a} to ${d} for memberId ${t} (early exit)`),S("member",t,d,864e5),d;if(c&&c.length>1e3){let u=I(c);if(u===a||u===d){let l=d||a;return o.info("[SUBDOMAIN]",`Found matching subdomain for memberId ${t}: ${l} (verified by currency, early exit)`),S("member",t,l,864e5),l}else{if(u&&u!==a&&u!==d)return o.info("[SUBDOMAIN]",`HTML currency indicates ${u} (tested ${a}, final URL: ${d||a}), using detected subdomain (early exit)`),S("member",t,u,864e5),u;{let l=d||a;n||(n=l,o.info("[SUBDOMAIN]",`Found valid HTML for subdomain ${l} (currency check inconclusive, storing as fallback)`))}}}}catch(c){let g=c instanceof Error?c:new Error(String(c));g.message&&!g.message.includes("404")&&o.warn("[SUBDOMAIN]",`Error trying subdomain ${a}:`,c)}}if(n)return o.info("[SUBDOMAIN]",`Using fallback subdomain for memberId ${t}: ${n} (no currency match found)`),S("member",t,n,864e5),n;let i=L(t,"au");try{let{html:a,finalUrl:s}=await T(i);if(a&&a.length>1e3){let c=M(s)||"au";return o.info("[SUBDOMAIN]",`Using default subdomain for memberId ${t}: ${c}`),S("member",t,c,864e5),c}}catch(a){o.warn("[SUBDOMAIN]","Error trying default subdomain:",a)}return o.warn("[SUBDOMAIN]",`Could not find working subdomain for memberId ${t}, using default: ${"au"}`),S("member",t,"au",864e5),"au"}catch(n){return gt(n instanceof Error?n:new Error(String(n)),{memberId:t,metadata:{timestamp:Date.now()}}),o.warn("[SUBDOMAIN]",`Failed to detect subdomain for memberId ${t}, using default:`,n),S("member",t,"au",864e5),"au"}}async function pt(t){return G[t]?G[t]:await Q(t)}async function At(t,r=!1){if(r)o.info("[SUBDOMAIN]",`Force refresh requested, skipping cache for teamId ${t}`);else{let n=ht("team",t);if(n)return o.info("[SUBDOMAIN]",`Found cached subdomain for teamId ${t}: ${n}`),n}o.info("[SUBDOMAIN]",`Detecting subdomain for teamId ${t}...`);let e=["au","uk","us","ca","nz","ie","za","nl","de","fr","es","it","cz","dk","se","ex"];try{let n=null;for(let a of e){let s=v(t,a);try{let{html:c,finalUrl:g}=await T(s),d=M(g);if(d&&d!==a)return o.info("[SUBDOMAIN]",`URL redirected from ${a} to ${d} for teamId ${t} (early exit)`),S("team",t,d,864e5),d;if(c&&c.length>1e3){let u=I(c);if(u===a||u===d){let l=d||a;return o.info("[SUBDOMAIN]",`Found matching subdomain for teamId ${t}: ${l} (verified by currency, early exit)`),S("team",t,l,864e5),l}else{if(u&&u!==a&&u!==d)return o.info("[SUBDOMAIN]",`HTML currency indicates ${u} (tested ${a}, final URL: ${d||a}), using detected subdomain (early exit)`),S("team",t,u,864e5),u;{let l=d||a;n||(n=l,o.info("[SUBDOMAIN]",`Found valid HTML for subdomain ${l} (currency check inconclusive, storing as fallback)`))}}}}catch(c){let g=c instanceof Error?c:new Error(String(c));g.message&&!g.message.includes("404")&&o.warn("[SUBDOMAIN]",`Error trying subdomain ${a}:`,c)}}if(n)return o.info("[SUBDOMAIN]",`Using fallback subdomain for teamId ${t}: ${n} (no currency match found)`),S("team",t,n,864e5),n;let i=v(t,"au");try{let{html:a,finalUrl:s}=await T(i);if(a&&a.length>1e3){let c=M(s)||"au";return o.info("[SUBDOMAIN]",`Using default subdomain for teamId ${t}: ${c}`),S("team",t,c,864e5),c}}catch(a){o.warn("[SUBDOMAIN]","Error trying default subdomain:",a)}return o.warn("[SUBDOMAIN]",`Could not find working subdomain for teamId ${t}, using default: ${"au"}`),S("team",t,"au",864e5),"au"}catch(n){return gt(n instanceof Error?n:new Error(String(n)),{memberId:t,metadata:{timestamp:Date.now()}}),o.warn("[SUBDOMAIN]",`Failed to detect subdomain for teamId ${t}, using default:`,n),S("team",t,"au",864e5),"au"}}async function Nt(t){return await At(t)}async function Ut(t,r=!1){let e=await pt(t),n=L(t,e),i=Date.now();o.info("[SCRAPE]",`Starting scrape of Movember page: ${n} (subdomain: ${e})`);try{o.info("[SCRAPE]",`Fetching HTML from ${n} via proxy...`);let a=Date.now(),s,c;try{let m=await T(n);s=m.html,c=m.finalUrl}catch(m){if(r&&m instanceof Error&&m.message.includes("404")){o.warn("[SCRAPE]",`Got 404 for ${n}, clearing cached subdomain and re-detecting...`),J("member",t);let E=await Q(t,!0);if(E!==e){o.info("[SCRAPE]",`Re-detected subdomain: ${E} (was ${e}), retrying with new subdomain...`);let N=L(t,E),k=await T(N);s=k.html,c=k.finalUrl,e=E}else throw new Error("HTTP error! status: 404 (page not found - member may not exist)")}else throw m}let g=Date.now()-a;o.info("[SCRAPE]",`HTML fetched successfully in ${w(g)} (${s.length} characters)`);let d=M(c);d&&d!==e&&(o.info("[SCRAPE]",`URL redirected from ${e} to ${d}, updating subdomain...`),e=d,S("member",t,e,864e5));let u=I(s);u&&u!==e?o.warn("[SCRAPE]",`HTML currency indicates subdomain ${u} but URL subdomain is ${e}. Trusting URL subdomain (primary source).`):u===e&&o.info("[SCRAPE]",`HTML currency verification confirms subdomain ${e}`);let{raised:l,target:h}=W(s,t,e);if(!l||!f(l)){let m=s.match(/\$[\d,]+(?:\.\d+)?/g);o.warn("[SCRAPE]",`Found ${m?m.length:0} dollar amounts in HTML:`,m?m.slice(0,10):[]);let E=s.match(/[\d,]{3,}(?:\.\d+)?/g);o.warn("[SCRAPE]",`Found ${E?E.length:0} potential amount numbers in HTML (showing first 20):`,E?E.slice(0,20):[]);let N={memberId:t,subdomain:e,url:n,message:"Could not find raised amount in HTML. The page may require JavaScript execution or the HTML structure may have changed.",htmlLength:s.length,dollarAmountsFound:m?m.length:0,raisedValue:l||"empty"};throw o.error("[SCRAPE]","Failed to extract raised amount:",N),new Error(`Could not find raised amount in HTML for memberId ${t} (subdomain: ${e}). The page may require JavaScript execution or the HTML structure may have changed. Found ${m?m.length:0} dollar amounts in HTML.`)}if(!f(l))throw new Error(`Invalid raised value captured: "${l}" for memberId ${t}`);let{value:b,currency:H}=K(`$${l}`,e);(!b||b==="0"||b==="")&&o.warn("[SCRAPE]",`Parsed raised value is invalid: "${b}" from input: "${l}"`);let F=nt(H),A={amount:`${F}${b}`,currency:H,subdomain:e,timestamp:Date.now()};if(h&&f(h)){let{value:m}=K(`$${h}`,e),E=`${F}${m}`;A.target=E,A.percentage=ot(b,m)}else h&&o.warn("[SCRAPE]",`Target value "${h}" failed validation, skipping target`);let rt=Date.now()-i;return o.info("[SCRAPE]",`Scraping completed successfully in ${w(rt)}:`,{amount:A.amount,target:A.target,percentage:A.percentage,currency:A.currency,subdomain:A.subdomain}),A}catch(a){let s=Date.now()-i,c=a instanceof Error?a.message:String(a);throw mt(a instanceof Error?a:new Error(c),{memberId:t,subdomain:e,url:n,metadata:{duration:s,timestamp:Date.now()}}),o.error("[SCRAPE]",`Scraping failed after ${w(s)}:`,c,a),a}}async function tt(t){let r=null,e=Date.now();o.info("[RETRY]",`Starting retry logic (max ${3} attempts) for memberId: ${t}`);for(let n=0;n<3;n++)try{o.info("[RETRY]",`Attempt ${n+1}/${3}`);let i=n===0||r?.message.includes("404"),a=await Ut(t,i),s=Date.now()-e;return o.info("[RETRY]",`Success on attempt ${n+1} after ${s}ms`),a}catch(i){r=i instanceof Error?i:new Error(String(i));let a=r.message;if(o.error("[RETRY]",`Attempt ${n+1} failed:`,a),a.includes("404")&&(o.info("[RETRY]",`404 detected, clearing subdomain cache for memberId: ${t}`),J("member",t)),n<2){let s=U[n]||U[U.length-1];o.info("[RETRY]",`Waiting ${s}ms before retry ${n+2}...`),await at(s)}else{let s=Date.now()-e;o.error("[RETRY]",`All ${3} attempts failed after ${s}ms`)}}throw r||new Error("Failed to scrape after all retries")}async function Zt(t,r=!1){let e=null,n="HIT";if(r)o.info("[LIVE]",`grab-live parameter detected - forcing fresh scrape for memberId: ${t}`),e=await tt(t),n="LIVE",o.info("[CACHE]",`Storing live data in cache with TTL: ${3e5}ms for memberId: ${t}`),O("member",t,e,3e5),o.info("[CACHE]","Live data stored successfully");else if(o.info("[CACHE]",`Checking cache for memberId: ${t}`),e=ft("member",t),e){let i=Date.now()-e.timestamp;o.info("[CACHE]",`Cache HIT - data age: ${Math.round(i/1e3)}s for memberId: ${t}`,{amount:e.amount,target:e.target,timestamp:new Date(e.timestamp).toISOString()})}else{let i=Et("member",t),a=St("member",t);i&&a?(o.info("[CACHE]",`Cache STALE - returning stale data immediately, fetching fresh data in background for memberId: ${t}`),e=i,n="STALE",tt(t).then(s=>{o.info("[CACHE]",`Background refresh completed for memberId: ${t}, updating cache`),O("member",t,s,3e5)}).catch(s=>{o.error("[CACHE]",`Background refresh failed for memberId: ${t}:`,s)})):(o.info("[CACHE]",`Cache MISS - need to scrape for memberId: ${t}`),e=await tt(t),n="MISS",o.info("[CACHE]",`Storing data in cache with TTL: ${3e5}ms for memberId: ${t}`),O("member",t,e,3e5),o.info("[CACHE]","Data stored successfully"))}if(!e)throw new Error(`Unexpected null data for memberId: ${t}. This should never happen.`);return{data:e,cacheStatus:n}}async function _t(t,r=!1){let e=await Nt(t),n=v(t,e),i=Date.now();o.info("[SCRAPE]",`Starting scrape of Movember team page: ${n} (subdomain: ${e})`);try{o.info("[SCRAPE]",`Fetching HTML from ${n} via proxy...`);let a=Date.now(),s,c;try{let m=await T(n);s=m.html,c=m.finalUrl}catch(m){if(r&&m instanceof Error&&m.message.includes("404")){o.warn("[SCRAPE]",`Got 404 for ${n}, clearing cached subdomain and re-detecting...`),J("team",t);let E=await At(t,!0);if(E!==e){o.info("[SCRAPE]",`Re-detected subdomain: ${E} (was ${e}), retrying with new subdomain...`);let N=v(t,E),k=await T(N);s=k.html,c=k.finalUrl,e=E}else throw new Error("HTTP error! status: 404 (page not found - team may not exist)")}else throw m}let g=Date.now()-a;o.info("[SCRAPE]",`HTML fetched successfully in ${w(g)} (${s.length} characters)`);let d=M(c);d&&d!==e&&(o.info("[SCRAPE]",`URL redirected from ${e} to ${d}, updating subdomain...`),e=d,S("team",t,e,864e5));let u=I(s);u&&u!==e?o.warn("[SCRAPE]",`HTML currency indicates subdomain ${u} but URL subdomain is ${e}. Trusting URL subdomain (primary source).`):u===e&&o.info("[SCRAPE]",`HTML currency verification confirms subdomain ${e}`);let{raised:l,target:h}=W(s,t,e);if(!l||!f(l)){let m=s.match(/\$[\d,]+(?:\.\d+)?/g);o.warn("[SCRAPE]",`Found ${m?m.length:0} dollar amounts in HTML:`,m?m.slice(0,10):[]);let E=s.match(/[\d,]{3,}(?:\.\d+)?/g);o.warn("[SCRAPE]",`Found ${E?E.length:0} potential amount numbers in HTML (showing first 20):`,E?E.slice(0,20):[]);let N={teamId:t,subdomain:e,url:n,message:"Could not find raised amount in HTML. The page may require JavaScript execution or the HTML structure may have changed.",htmlLength:s.length,dollarAmountsFound:m?m.length:0,raisedValue:l||"empty"};throw o.error("[SCRAPE]","Failed to extract raised amount:",N),new Error(`Could not find raised amount in HTML for teamId ${t} (subdomain: ${e}). The page may require JavaScript execution or the HTML structure may have changed. Found ${m?m.length:0} dollar amounts in HTML.`)}if(!f(l))throw new Error(`Invalid raised value captured: "${l}" for teamId ${t}`);let{value:b,currency:H}=K(`$${l}`,e);(!b||b==="0"||b==="")&&o.warn("[SCRAPE]",`Parsed raised value is invalid: "${b}" from input: "${l}"`);let F=nt(H),A={amount:`${F}${b}`,currency:H,subdomain:e,timestamp:Date.now()};if(h&&f(h)){let{value:m}=K(`$${h}`,e),E=`${F}${m}`;A.target=E,A.percentage=ot(b,m)}else h&&o.warn("[SCRAPE]",`Target value "${h}" failed validation, skipping target`);let rt=Date.now()-i;return o.info("[SCRAPE]",`Scraping completed successfully in ${w(rt)}:`,{amount:A.amount,target:A.target,percentage:A.percentage,currency:A.currency,subdomain:A.subdomain}),A}catch(a){let s=Date.now()-i,c=a instanceof Error?a.message:String(a);throw mt(a instanceof Error?a:new Error(c),{memberId:t,subdomain:e,url:n,metadata:{duration:s,timestamp:Date.now()}}),o.error("[SCRAPE]",`Scraping failed after ${w(s)}:`,c,a),a}}async function et(t){let r=null,e=Date.now();o.info("[RETRY]",`Starting retry logic (max ${3} attempts) for teamId: ${t}`);for(let n=0;n<3;n++)try{o.info("[RETRY]",`Attempt ${n+1}/${3}`);let i=n===0||r?.message.includes("404"),a=await _t(t,i),s=Date.now()-e;return o.info("[RETRY]",`Success on attempt ${n+1} after ${s}ms`),a}catch(i){r=i instanceof Error?i:new Error(String(i));let a=r.message;if(o.error("[RETRY]",`Attempt ${n+1} failed:`,a),a.includes("404")&&(o.info("[RETRY]",`404 detected, clearing subdomain cache for teamId: ${t}`),J("team",t)),n<2){let s=U[n]||U[U.length-1];o.info("[RETRY]",`Waiting ${s}ms before retry ${n+2}...`),await at(s)}else{let s=Date.now()-e;o.error("[RETRY]",`All ${3} attempts failed after ${s}ms`)}}throw r||new Error("Failed to scrape after all retries")}async function Wt(t,r=!1){let e=null,n="HIT";if(r)o.info("[LIVE]",`grab-live parameter detected - forcing fresh scrape for teamId: ${t}`),e=await et(t),n="LIVE",o.info("[CACHE]",`Storing live data in cache with TTL: ${3e5}ms for teamId: ${t}`),O("team",t,e,3e5),o.info("[CACHE]","Live data stored successfully");else if(o.info("[CACHE]",`Checking cache for teamId: ${t}`),e=ft("team",t),e){let i=Date.now()-e.timestamp;o.info("[CACHE]",`Cache HIT - data age: ${Math.round(i/1e3)}s for teamId: ${t}`,{amount:e.amount,target:e.target,timestamp:new Date(e.timestamp).toISOString()})}else{let i=Et("team",t),a=St("team",t);i&&a?(o.info("[CACHE]",`Cache STALE - returning stale data immediately, fetching fresh data in background for teamId: ${t}`),e=i,n="STALE",et(t).then(s=>{o.info("[CACHE]",`Background refresh completed for teamId: ${t}, updating cache`),O("team",t,s,3e5)}).catch(s=>{o.error("[CACHE]",`Background refresh failed for teamId: ${t}:`,s)})):(o.info("[CACHE]",`Cache MISS - need to scrape for teamId: ${t}`),e=await et(t),n="MISS",o.info("[CACHE]",`Storing data in cache with TTL: ${3e5}ms for teamId: ${t}`),O("team",t,e,3e5),o.info("[CACHE]","Data stored successfully"))}if(!e)throw new Error(`Unexpected null data for teamId: ${t}. This should never happen.`);return{data:e,cacheStatus:n}}export{Ot as DEFAULT_MEMBER_ID,L as buildMovemberUrl,Q as detectSubdomainForMember,I as detectSubdomainFromHtml,W as extractAmounts,wt as extractRaisedAmount,M as extractSubdomainFromUrl,xt as extractTargetAmount,T as fetchViaProxy,Zt as getData,pt as getSubdomainForMember,Wt as getTeamData,Ut as scrapeMovemberPage,_t as scrapeTeamPage,et as scrapeTeamWithRetry,tt as scrapeWithRetry};
//# sourceMappingURL=bundle.js.map
