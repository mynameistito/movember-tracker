var P={};var nt="https://{subdomain}.movember.com/donate/details",$t="14810348";var L=[1e3,2e3,4e3],Dt={uk:"GBP",au:"AUD",us:"USD",ca:"CAD",nz:"NZD",ie:"EUR",za:"ZAR",nl:"EUR",de:"EUR",fr:"EUR",es:"EUR",it:"EUR",ex:"EUR",cz:"CZK",dk:"DKK",se:"SEK"};function at(t){return t&&Dt[t.toLowerCase()]||"AUD"}var Tt={USD:"$",AUD:"$",CAD:"$",NZD:"$",GBP:"\xA3",EUR:"\u20AC",JPY:"\xA5",ZAR:"R",CZK:"K\u010D",DKK:"kr",SEK:"kr"};function ot(t){return t&&Tt[t.toUpperCase()]||"$"}function it(){return`${window.location.origin}/proxy`}var y=t=>{let e=Math.round(t/1e3),r=Math.floor(e/60),n=e%60;return r>0?`${r}m ${n}s (${t}ms)`:`${e}s (${t}ms)`},st=t=>new Promise(e=>setTimeout(e,t));var h={DEBUG:0,INFO:1,WARN:2,ERROR:3,NONE:4},w=h.INFO;function yt(){try{let e=localStorage.getItem("LOG_LEVEL");if(e){let r=e.toUpperCase();if(r in h){w=h[r];return}}}catch(e){typeof console<"u"&&console.warn&&console.warn("[LOGGER] localStorage unavailable, using default log level:",e instanceof Error?e.message:String(e))}w=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"||window.location.search.includes("debug=true")?h.DEBUG:h.INFO}yt();function v(t,e,...r){return[`[${new Date().toISOString()}] [${t}] ${e}`,...r]}function I(t){return h[t]>=w}var ct={setLevel(t){let e=t.toUpperCase();if(e in h){w=h[e];try{localStorage.setItem("LOG_LEVEL",e)}catch(r){try{ct.warn("[LOGGER]","Failed to persist log level to localStorage:",r instanceof Error?r.message:String(r))}catch{typeof console<"u"&&console.warn&&console.warn("[LOGGER] Failed to persist log level:",r instanceof Error?r.message:String(r))}}}},getLevel(){for(let[t,e]of Object.entries(h))if(e===w)return t;return"INFO"},debug(t,...e){I("DEBUG")&&console.debug(...v("DEBUG",t,...e))},info(t,...e){I("INFO")&&console.log(...v("INFO",t,...e))},warn(t,...e){I("WARN")&&console.warn(...v("WARN",t,...e))},error(t,...e){I("ERROR")&&console.error(...v("ERROR",t,...e))}},o=ct;var V=(t,e)=>{let r=t.trim(),n=e?at(e):"AUD",a=r.replace(/[$€£¥]|\b(USD|EUR|GBP|AUD|JPY|CAD|NZD|ZAR)\b/gi,"").trim().match(/[\d,]+\.?\d*/);return{value:a?a[0]:"0",currency:n}},g=t=>{if(!t||typeof t!="string")return!1;let e=t.replace(/[,.\s$€£¥]/g,"");return!(!e||e.length===0||!/^\d+$/.test(e)||!/\d/.test(t)||/^[,.\s$€£¥]+$/.test(t))},ut=(t,e)=>{let r=parseFloat(t.replace(/,/g,"")),n=parseFloat(e.replace(/,/g,""));return n===0?0:Math.round(r/n*100)};var dt={SUBDOMAIN:/https?:\/\/([^.]+)\.movember\.com/},p=[/\bGBP\b[\s:]*[\d,]+|[\d,]+[\s:]*\bGBP\b|British\s+Pound/i,/\bEUR\b[\s:]*[\d,]+|[\d,]+[\s:]*\bEUR\b|Euro[\s:]*[\d,]+/i,/\bUSD\b[\s:]*[\d,]+|[\d,]+[\s:]*\bUSD\b|US\s+Dollar/i,/\bAUD\b[\s:]*[\d,]+|[\d,]+[\s:]*\bAUD\b|Australian\s+Dollar/i,/\bCAD\b[\s:]*[\d,]+|[\d,]+[\s:]*\bCAD\b|Canadian\s+Dollar/i,/\bNZD\b[\s:]*[\d,]+|[\d,]+[\s:]*\bNZD\b|New\s+Zealand\s+Dollar/i,/\bZAR\b[\s:]*[\d,]+|[\d,]+[\s:]*\bZAR\b|South\s+African\s+Rand/i,/\bCZK\b[\s:]*[\d,]+|[\d,]+[\s:]*\bCZK\b|Czech\s+Koruna|Kč[\d,]+/i,/\bSEK\b[\s:]*[\d,]+|[\d,]+[\s:]*\bSEK\b|Swedish\s+Krona/i,/\bDKK\b[\s:]*[\d,]+|[\d,]+[\s:]*\bDKK\b|Danish\s+Krone/i],m={IRELAND:/Ireland|Irish/i,NETHERLANDS:/Netherlands|Dutch/i,GERMANY:/Germany|German/i,FRANCE:/France|French/i,SPAIN:/Spain|Spanish/i,ITALY:/Italy|Italian/i,UNITED_STATES:/United\s+States|US\s+Dollar/i,CANADA:/Canada|Canadian/i,NEW_ZEALAND:/New\s+Zealand/i,AUSTRALIA:/Australia|Australian/i},lt=/\$[\d,]+/,J=[/"AmountRaised"[^}]*"(?:convertedAmount|originalAmount)"["\s:]*["']([\d,]+(?:\.\d+)?)/i,/donationProgress--amount__raised[^>]*>([^<]*\$([\d,]+(?:\.\d+)?)[^<]*)/i,/class="[^"]*donationProgress--amount__raised[^"]*"[^>]*>[\s\S]*?\$([\d,]+(?:\.\d+)?)/i,/"(?:raised|raisedAmount|currentAmount)"[:\s]*["']?\$?([\d,]+(?:\.\d+)?)/i,/data-(?:raised|amount)=["']?\$?([\d,]+(?:\.\d+)?)/i,/donationProgress--amount__raised[^>]*>([^<]*[€£$]([\d,]+(?:\.\d+)?)[^<]*)/i,/donationProgress--amount__raised[^>]*>([^<]*(?:USD|EUR|GBP|AUD)\s*([\d,]+(?:\.\d+)?)[^<]*)/i],Z=[/"target"[^}]*"fundraising"[^}]*"value"["\s:]*["']([\d,]+(?:\.\d+)?)/i,/donationProgress--amount__target[^>]*>([^<]*\$([\d,]+(?:\.\d+)?)[^<]*)/i,/class="[^"]*donationProgress--amount__target[^"]*"[^>]*>[\s\S]*?\$([\d,]+(?:\.\d+)?)/i,/"(?:target|targetAmount|goal)"[:\s]*["']?\$?([\d,]+(?:\.\d+)?)/i,/data-(?:target|goal)=["']?\$?([\d,]+(?:\.\d+)?)/i,/donationProgress--amount__target[^>]*>([^<]*[€£$]([\d,]+(?:\.\d+)?)[^<]*)/i,/donationProgress--amount__target[^>]*>([^<]*(?:USD|EUR|GBP|AUD)\s*([\d,]+(?:\.\d+)?)[^<]*)/i],U=[/"(?:raised|raisedAmount|currentAmount|donationAmount|amount)"[:\s]*["']?\$?([\d,]+(?:\.\d+)?)/i,/raised[:\s]*["']?\$?([\d,]+(?:\.\d+)?)/i],M=[/"(?:target|targetAmount|goal)"[:\s]*["']?\$?([\d,]+(?:\.\d+)?)/i,/(?:target|goal)[:\s]*["']?\$?([\d,]+(?:\.\d+)?)/i],W=[/\$([\d,]+(?:\.\d+)?)\s*(?:raised|donated|collected)/i,/(?:raised|donated|collected)[:\s]*\$([\d,]+(?:\.\d+)?)/i,/<[^>]+class="[^"]*(?:amount|raised|donation|progress)[^"]*"[^>]*>\s*\$?([\d,]+(?:\.\d+)?)/i,/data-[^=]*amount[^=]*=["']?\$?([\d,]+(?:\.\d+)?)/i,/\$([\d,]+(?:\.\d+)?)\s*(?:of|out of)/i,/raised[:\s=]+[$]?([\d,]+(?:\.\d+)?)/i,/amount[:\s=]+[$]?([\d,]+(?:\.\d+)?)/i],z=[/\$([\d,]+(?:\.\d+)?)\s*(?:target|goal)/i,/(?:target|goal)[:\s]*\$([\d,]+(?:\.\d+)?)/i,/<[^>]+class="[^"]*(?:target|goal)[^"]*"[^>]*>\s*\$?([\d,]+(?:\.\d+)?)/i,/data-[^=]*(?:target|goal)[^=]*=["']?\$?([\d,]+(?:\.\d+)?)/i,/\$([\d,]+(?:\.\d+)?)\s*(?:of|out of)\s*\$([\d,]+(?:\.\d+)?)/i,/target[:\s=]+[$]?([\d,]+(?:\.\d+)?)/i,/goal[:\s=]+[$]?([\d,]+(?:\.\d+)?)/i];function xt(t){try{let r=new DOMParser().parseFromString(t,"text/html"),n=[".donationProgress--amount__raised",'[class*="donationProgress--amount__raised"]','[class*="raised"]',"[data-raised]","[data-amount]","[data-raised-amount]"];for(let a of n){let s=r.querySelectorAll(a);for(let c of Array.from(s)){let d=(c.textContent||c.innerText||"").match(/[\d,]+(?:\.\d+)?/);if(d&&g(d[0]))return o.info("[SCRAPE]",`Found raised amount using DOMParser with selector "${a}": ${d[0]}`),d[0];let u=c.getAttribute("data-raised")||c.getAttribute("data-amount")||c.getAttribute("data-raised-amount");if(u&&g(u))return o.info("[SCRAPE]",`Found raised amount using DOMParser data attribute: ${u}`),u}}let i=r.querySelectorAll("script");for(let a of Array.from(i)){let s=a.textContent||a.innerHTML||"";for(let c=0;c<U.length;c++){let l=U[c],d=s.match(l);if(d){let u=d[1];if(g(u))return o.info("[SCRAPE]",`Found raised amount in JSON using DOMParser: ${u}`),u}}}}catch(e){o.warn("[SCRAPE]","DOMParser extraction failed, falling back to regex:",e)}return""}function gt(t){let e=xt(t);if(e)return e;o.info("[SCRAPE]","DOMParser didn't find raised amount, trying regex patterns..."),e="";for(let r=0;r<J.length;r++){let n=J[r],i=t.match(n);if(i){let a=i[i.length-1];if((!a||!g(a))&&i.length>2&&(a=i[i.length-2]),o.debug("[SCRAPE]",`Pattern ${r+1} matched, all groups:`,i.slice(1),`using: "${a}"`),g(a)){e=a,o.info("[SCRAPE]",`Found valid raised amount using pattern ${r+1}: ${e}`);break}else o.warn("[SCRAPE]",`Pattern ${r+1} matched but invalid number: "${a}", trying next pattern...`)}}if(!e){o.info("[SCRAPE]","Checking for JSON data in script tags...");let r=t.match(/<script[^>]*>([\s\S]*?)<\/script>/gi);if(r)for(let n of r){for(let i=0;i<U.length;i++){let a=U[i],s=n.match(a);if(s){let c=s[1];if(g(c)){e=c,o.info("[SCRAPE]",`Found valid raised amount in JSON using pattern ${i+1}: ${e}`);break}else o.warn("[SCRAPE]",`JSON raised pattern ${i+1} matched but invalid number: "${c}"`)}}if(e)break}}if(!e){o.info("[SCRAPE]","Trying generic dollar amount patterns as last resort...");for(let r=0;r<W.length;r++){let n=W[r],i=t.match(n);if(i){let a=i[1];if(g(a)){e=a,o.info("[SCRAPE]",`Found valid raised amount using generic pattern ${r+1}: ${e}`);break}else o.warn("[SCRAPE]",`Generic pattern ${r+1} matched but invalid number: "${a}"`)}}}if(!e){o.info("[SCRAPE]","Performing aggressive context-based search...");let r=[...t.matchAll(/\$([\d,]+(?:\.\d+)?)/g)];if(o.debug("[SCRAPE]",`Found ${r.length} dollar amounts in HTML`),r.length>0){let n=[];for(let i of r){let a=i[1];if(!g(a))continue;let s=i.index??0,c=Math.max(0,s-300),l=Math.min(t.length,s+i[0].length+300),d=t.substring(c,l).toLowerCase(),u=0;/(?:raised|donated|collected|current|funds?|progress|amount\s*(?:raised|donated))/i.test(d)&&(u+=10),/(?:has\s+raised|has\s+donated|has\s+collected|currently\s+raised)/i.test(d)&&(u+=5),/\$[\d,]+(?:\.\d+)?\s*(?:raised|donated|collected)/i.test(d)&&(u+=8),u>0&&n.push({amount:a,score:u,raisedScore:u,context:d.substring(0,200)})}if(n.sort((i,a)=>a.raisedScore-i.raisedScore),n.length>0){let i=n.filter(a=>a.raisedScore>0).sort((a,s)=>s.raisedScore-a.raisedScore);i.length>0&&(e=i[0].amount,o.info("[SCRAPE]",`Found raised amount via context search: ${e} (raisedScore: ${i[0].raisedScore})`))}}}return e}function Nt(t){try{let r=new DOMParser().parseFromString(t,"text/html"),n=[".donationProgress--amount__target",'[class*="donationProgress--amount__target"]','[class*="target"]','[class*="goal"]',"[data-target]","[data-goal]","[data-target-amount]"];for(let a of n){let s=r.querySelectorAll(a);for(let c of Array.from(s)){let d=(c.textContent||c.innerText||"").match(/[\d,]+(?:\.\d+)?/);if(d&&g(d[0]))return o.info("[SCRAPE]",`Found target amount using DOMParser with selector "${a}": ${d[0]}`),d[0];let u=c.getAttribute("data-target")||c.getAttribute("data-goal")||c.getAttribute("data-target-amount");if(u&&g(u))return o.info("[SCRAPE]",`Found target amount using DOMParser data attribute: ${u}`),u}}let i=r.querySelectorAll("script");for(let a of Array.from(i)){let s=a.textContent||a.innerHTML||"";for(let c=0;c<M.length;c++){let l=M[c],d=s.match(l);if(d){let u=d[1];if(g(u))return o.info("[SCRAPE]",`Found target amount in JSON using DOMParser: ${u}`),u}}}}catch(e){o.warn("[SCRAPE]","DOMParser extraction failed, falling back to regex:",e)}return""}function ft(t){let e=Nt(t);if(e)return e;o.info("[SCRAPE]","DOMParser didn't find target amount, trying regex patterns..."),e="";for(let r=0;r<Z.length;r++){let n=Z[r],i=t.match(n);if(i){let a=i[i.length-1];if((!a||!g(a))&&i.length>2&&(a=i[i.length-2]),o.debug("[SCRAPE]",`Target pattern ${r+1} matched, all groups:`,i.slice(1),`using: "${a}"`),g(a)){e=a,o.info("[SCRAPE]",`Found valid target amount using pattern ${r+1}: ${e}`);break}else o.warn("[SCRAPE]",`Target pattern ${r+1} matched but invalid number: "${a}", trying next pattern...`)}}if(!e){let r=t.match(/<script[^>]*>([\s\S]*?)<\/script>/gi);if(r)for(let n of r){for(let i=0;i<M.length;i++){let a=M[i],s=n.match(a);if(s){let c=s[1];if(g(c)){e=c,o.info("[SCRAPE]",`Found valid target amount in JSON using pattern ${i+1}: ${e}`);break}else o.warn("[SCRAPE]",`JSON target pattern ${i+1} matched but invalid number: "${c}"`)}}if(e)break}}if(!e){o.info("[SCRAPE]","Trying generic target amount patterns as last resort...");for(let r=0;r<z.length;r++){let n=z[r],i=t.match(n);if(i){let a=null;for(let s=i.length-1;s>=1;s--)if(i[s]&&g(i[s])){a=i[s];break}if(a){e=a,o.info("[SCRAPE]",`Found valid target amount using generic pattern ${r+1}: ${e}`);break}else o.warn("[SCRAPE]",`Generic target pattern ${r+1} matched but no valid number found in capture groups`)}}}if(!e){let r=[...t.matchAll(/\$([\d,]+(?:\.\d+)?)/g)];if(r.length>0){let n=[];for(let i of r){let a=i[1];if(!g(a))continue;let s=i.index??0,c=Math.max(0,s-300),l=Math.min(t.length,s+i[0].length+300),d=t.substring(c,l).toLowerCase(),u=0;/(?:target|goal|aim|objective|of\s+\$)/i.test(d)&&(u+=10),/(?:target\s+(?:of|is)|goal\s+(?:of|is)|aim\s+(?:of|is))/i.test(d)&&(u+=5),/\$[\d,]+(?:\.\d+)?\s*(?:target|goal)/i.test(d)&&(u+=8),u>0&&n.push({amount:a,score:u,targetScore:u,context:d.substring(0,200)})}if(n.sort((i,a)=>a.targetScore-i.targetScore),n.length>0){let i=n.filter(a=>a.targetScore>0).sort((a,s)=>s.targetScore-a.targetScore);i.length>0&&(e=i[0].amount,o.info("[SCRAPE]",`Found target amount via context search: ${e} (targetScore: ${i[0].targetScore})`))}}}return e}function q(t,e,r){let n=Date.now();o.info("[SCRAPE]","Extracting data from HTML...");let i=gt(t),a=ft(t),s=Date.now()-n;return o.info("[SCRAPE]",`Data extraction completed in ${y(s)}`),o.debug("[SCRAPE]",`Raw extracted data for memberId ${e} (subdomain: ${r}):`,{raised:i||"NOT FOUND",target:a||"NOT FOUND"}),{raised:i,target:a}}var F={LOW:"low",MEDIUM:"medium",HIGH:"high",CRITICAL:"critical"},k={SCRAPING:"scraping",SUBDOMAIN:"subdomain",CACHE:"cache",NETWORK:"network",PARSING:"parsing",VALIDATION:"validation",UNKNOWN:"unknown"};function j(t,e={}){let r={timestamp:new Date().toISOString(),message:t instanceof Error?t.message:String(t),stack:t instanceof Error?t.stack:void 0,category:e.category||k.UNKNOWN,severity:e.severity||F.MEDIUM,context:{memberId:e.memberId,subdomain:e.subdomain,url:e.url,...e.metadata||{}}};o.error("[ERROR_TRACKING]",`[${r.category}] [${r.severity}] ${r.message}`,r);try{let n=JSON.parse(localStorage.getItem("error_tracking_log")||"[]");n.push(r),n.length>50&&n.shift(),localStorage.setItem("error_tracking_log",JSON.stringify(n))}catch(n){o.warn("[ERROR_TRACKING]","Failed to store error in localStorage:",n)}return r}function mt(t,e={}){return j(t,{category:k.SCRAPING,severity:F.HIGH,...e})}function Et(t,e={}){return j(t,{category:k.SUBDOMAIN,severity:F.MEDIUM,...e})}function St(t,e={}){return j(t,{category:k.NETWORK,severity:F.HIGH,...e})}function x(t){let e=t.match(dt.SUBDOMAIN);return e?e[1]:null}async function b(t){let e=`${it()}?url=${encodeURIComponent(t)}`,r=await fetch(e);if(!r.ok){let a=`Proxy error! status: ${r.status}`;try{if(r.headers.get("content-type")?.includes("application/json")){let l=await r.json();l.message&&(a=l.message)}else{let l=await r.text();l&&(a=l.substring(0,200))}}catch(c){o.warn("[PROXY]","Could not parse error response:",c)}let s=new Error(a);throw St(s,{url:t,metadata:{status:r.status,statusText:r.statusText}}),s}let n=await r.text(),i=r.headers.get("X-Final-URL")||t;return{html:n,finalUrl:i}}function $(t,e){return`${nt.replace("{subdomain}",e)}?memberId=${t}`}function pt(t){try{let e=`movember:data:${t}`,r=localStorage.getItem(e);if(!r)return null;let n=JSON.parse(r);return Date.now()-n.cachedAt>n.ttl?(localStorage.removeItem(e),null):n.data}catch(e){return o.warn("[CACHE]","Error reading cached data:",e),null}}function At(t){try{let e=`movember:data:${t}`,r=localStorage.getItem(e);return r?JSON.parse(r).data:null}catch(e){return o.warn("[CACHE]","Error reading stale cached data:",e),null}}function Rt(t){try{let e=`movember:data:${t}`,r=localStorage.getItem(e);if(!r)return!1;let n=JSON.parse(r);return Date.now()-n.cachedAt>n.ttl}catch(e){return o.warn("[CACHE]","Error checking if cached data is stale:",e),!1}}function H(t,e,r){try{let n=`movember:data:${t}`,i={data:e,cachedAt:Date.now(),ttl:r};localStorage.setItem(n,JSON.stringify(i))}catch(n){o.warn("[CACHE]","Error setting cached data:",n)}}function ht(t){try{let e=`movember:subdomain:${t}`,r=localStorage.getItem(e);if(!r)return null;let n=JSON.parse(r);return Date.now()-n.cachedAt>n.ttl?(localStorage.removeItem(e),null):n.subdomain}catch(e){return o.warn("[CACHE]","Error reading cached subdomain:",e),null}}function A(t,e,r){try{let n=`movember:subdomain:${t}`,i={subdomain:e,cachedAt:Date.now(),ttl:r};localStorage.setItem(n,JSON.stringify(i))}catch(n){o.warn("[CACHE]","Error setting cached subdomain:",n)}}function X(t){try{let e=`movember:data:${t}`;localStorage.removeItem(e);let r=`movember:subdomain:${t}`;localStorage.removeItem(r);let n=`movember:amount:${t}`;localStorage.removeItem(n)}catch(e){o.warn("[CACHE]","Error clearing cached data:",e)}}function G(t){return t?t.includes("\xA3")||t.includes("&pound;")||t.includes("&#163;")?"uk":t.includes("\u20AC")||t.includes("&euro;")||t.includes("&#8364;")?t.match(m.IRELAND)?"ie":t.match(m.NETHERLANDS)?"nl":t.match(m.GERMANY)?"de":t.match(m.FRANCE)?"fr":t.match(m.SPAIN)?"es":t.match(m.ITALY)?"it":"ie":p[0].test(t)?"uk":p[1].test(t)?t.match(m.IRELAND)?"ie":t.match(m.NETHERLANDS)?"nl":t.match(m.GERMANY)?"de":t.match(m.FRANCE)?"fr":t.match(m.SPAIN)?"es":t.match(m.ITALY)?"it":"ie":p[2].test(t)?"us":p[3].test(t)?"au":p[4].test(t)?"ca":p[5].test(t)?"nz":p[6].test(t)?"za":p[7].test(t)?"cz":p[8].test(t)?"se":p[9].test(t)?"dk":lt.test(t)?t.match(m.UNITED_STATES)?"us":t.match(m.CANADA)?"ca":t.match(m.NEW_ZEALAND)?"nz":(t.match(m.AUSTRALIA),"au"):null:null}async function B(t,e=!1){if(e)o.info("[SUBDOMAIN]",`Force refresh requested, skipping cache for memberId ${t}`);else{let n=ht(t);if(n)return o.info("[SUBDOMAIN]",`Found cached subdomain for memberId ${t}: ${n}`),n}if(P[t]){let n=P[t];return o.info("[SUBDOMAIN]",`Using manual override for memberId ${t}: ${n}`),A(t,n,864e5),n}o.info("[SUBDOMAIN]",`Detecting subdomain for memberId ${t}...`);let r=["au","uk","us","ca","nz","ie","za","nl","de","fr","es","it","cz","dk","se","ex"];try{let n=null;for(let a of r){let s=$(t,a);try{let{html:c,finalUrl:l}=await b(s),d=x(l);if(d&&d!==a)return o.info("[SUBDOMAIN]",`URL redirected from ${a} to ${d} for memberId ${t} (early exit)`),A(t,d,864e5),d;if(c&&c.length>1e3){let u=G(c);if(u===a||u===d){let E=d||a;return o.info("[SUBDOMAIN]",`Found matching subdomain for memberId ${t}: ${E} (verified by currency, early exit)`),A(t,E,864e5),E}else{if(u&&u!==a&&u!==d)return o.info("[SUBDOMAIN]",`HTML currency indicates ${u} (tested ${a}, final URL: ${d||a}), using detected subdomain (early exit)`),A(t,u,864e5),u;{let E=d||a;n||(n=E,o.info("[SUBDOMAIN]",`Found valid HTML for subdomain ${E} (currency check inconclusive, storing as fallback)`))}}}}catch(c){let l=c instanceof Error?c:new Error(String(c));l.message&&!l.message.includes("404")&&o.warn("[SUBDOMAIN]",`Error trying subdomain ${a}:`,c)}}if(n)return o.info("[SUBDOMAIN]",`Using fallback subdomain for memberId ${t}: ${n} (no currency match found)`),A(t,n,864e5),n;let i=$(t,"au");try{let{html:a,finalUrl:s}=await b(i);if(a&&a.length>1e3){let c=x(s)||"au";return o.info("[SUBDOMAIN]",`Using default subdomain for memberId ${t}: ${c}`),A(t,c,864e5),c}}catch(a){o.warn("[SUBDOMAIN]","Error trying default subdomain:",a)}return o.warn("[SUBDOMAIN]",`Could not find working subdomain for memberId ${t}, using default: ${"au"}`),A(t,"au",864e5),"au"}catch(n){return Et(n instanceof Error?n:new Error(String(n)),{memberId:t,metadata:{timestamp:Date.now()}}),o.warn("[SUBDOMAIN]",`Failed to detect subdomain for memberId ${t}, using default:`,n),A(t,"au",864e5),"au"}}async function Q(t){return P[t]?P[t]:await B(t)}async function Ct(t,e=!1){let r=await Q(t),n=$(t,r),i=Date.now();o.info("[SCRAPE]",`Starting scrape of Movember page: ${n} (subdomain: ${r})`);try{o.info("[SCRAPE]",`Fetching HTML from ${n} via proxy...`);let a=Date.now(),s,c;try{let f=await b(n);s=f.html,c=f.finalUrl}catch(f){if(e&&f instanceof Error&&f.message.includes("404")){o.warn("[SCRAPE]",`Got 404 for ${n}, clearing cached subdomain and re-detecting...`),X(t);let S=await B(t,!0);if(S!==r){o.info("[SCRAPE]",`Re-detected subdomain: ${S} (was ${r}), retrying with new subdomain...`);let Y=$(t,S),et=await b(Y);s=et.html,c=et.finalUrl,r=S}else throw new Error("HTTP error! status: 404 (page not found - member may not exist)")}else throw f}let l=Date.now()-a;o.info("[SCRAPE]",`HTML fetched successfully in ${y(l)} (${s.length} characters)`);let d=x(c);d&&d!==r&&(o.info("[SCRAPE]",`URL redirected from ${r} to ${d}, updating subdomain...`),r=d,A(t,r,864e5));let u=G(s);u&&u!==r?o.warn("[SCRAPE]",`HTML currency indicates subdomain ${u} but URL subdomain is ${r}. Trusting URL subdomain (primary source).`):u===r&&o.info("[SCRAPE]",`HTML currency verification confirms subdomain ${r}`);let{raised:E,target:N}=q(s,t,r);if(!E||!g(E)){let f=s.match(/\$[\d,]+(?:\.\d+)?/g);o.warn("[SCRAPE]",`Found ${f?f.length:0} dollar amounts in HTML:`,f?f.slice(0,10):[]);let S=s.match(/[\d,]{3,}(?:\.\d+)?/g);o.warn("[SCRAPE]",`Found ${S?S.length:0} potential amount numbers in HTML (showing first 20):`,S?S.slice(0,20):[]);let Y={memberId:t,subdomain:r,url:n,message:"Could not find raised amount in HTML. The page may require JavaScript execution or the HTML structure may have changed.",htmlLength:s.length,dollarAmountsFound:f?f.length:0,raisedValue:E||"empty"};throw o.error("[SCRAPE]","Failed to extract raised amount:",Y),new Error(`Could not find raised amount in HTML for memberId ${t} (subdomain: ${r}). The page may require JavaScript execution or the HTML structure may have changed. Found ${f?f.length:0} dollar amounts in HTML.`)}if(!g(E))throw new Error(`Invalid raised value captured: "${E}" for memberId ${t}`);let{value:T,currency:tt}=V(`$${E}`,r);(!T||T==="0"||T==="")&&o.warn("[SCRAPE]",`Parsed raised value is invalid: "${T}" from input: "${E}"`);let rt=ot(tt),C={amount:`${rt}${T}`,currency:tt,subdomain:r,timestamp:Date.now()};if(N&&g(N)){let{value:f}=V(`$${N}`,r),S=`${rt}${f}`;C.target=S,C.percentage=ut(T,f)}else N&&o.warn("[SCRAPE]",`Target value "${N}" failed validation, skipping target`);let bt=Date.now()-i;return o.info("[SCRAPE]",`Scraping completed successfully in ${y(bt)}:`,{amount:C.amount,target:C.target,percentage:C.percentage,currency:C.currency,subdomain:C.subdomain}),C}catch(a){let s=Date.now()-i,c=a instanceof Error?a.message:String(a);throw mt(a instanceof Error?a:new Error(c),{memberId:t,subdomain:r,url:n,metadata:{duration:s,timestamp:Date.now()}}),o.error("[SCRAPE]",`Scraping failed after ${y(s)}:`,c,a),a}}async function K(t){let e=null,r=Date.now();o.info("[RETRY]",`Starting retry logic (max ${3} attempts) for memberId: ${t}`);for(let n=0;n<3;n++)try{o.info("[RETRY]",`Attempt ${n+1}/${3}`);let i=n===0||e?.message.includes("404"),a=await Ct(t,i),s=Date.now()-r;return o.info("[RETRY]",`Success on attempt ${n+1} after ${s}ms`),a}catch(i){e=i instanceof Error?i:new Error(String(i));let a=e.message;if(o.error("[RETRY]",`Attempt ${n+1} failed:`,a),a.includes("404")&&(o.info("[RETRY]",`404 detected, clearing subdomain cache for memberId: ${t}`),X(t)),n<2){let s=L[n]||L[L.length-1];o.info("[RETRY]",`Waiting ${s}ms before retry ${n+2}...`),await st(s)}else{let s=Date.now()-r;o.error("[RETRY]",`All ${3} attempts failed after ${s}ms`)}}throw e||new Error("Failed to scrape after all retries")}async function Pt(t,e=!1){let r=null,n="HIT";if(e)o.info("[LIVE]",`grab-live parameter detected - forcing fresh scrape for memberId: ${t}`),r=await K(t),n="LIVE",o.info("[CACHE]",`Storing live data in cache with TTL: ${3e5}ms for memberId: ${t}`),H(t,r,3e5),o.info("[CACHE]","Live data stored successfully");else if(o.info("[CACHE]",`Checking cache for memberId: ${t}`),r=pt(t),r){let i=Date.now()-r.timestamp;o.info("[CACHE]",`Cache HIT - data age: ${Math.round(i/1e3)}s for memberId: ${t}`,{amount:r.amount,target:r.target,timestamp:new Date(r.timestamp).toISOString()})}else{let i=At(t),a=Rt(t);i&&a?(o.info("[CACHE]",`Cache STALE - returning stale data immediately, fetching fresh data in background for memberId: ${t}`),r=i,n="STALE",K(t).then(s=>{o.info("[CACHE]",`Background refresh completed for memberId: ${t}, updating cache`),H(t,s,3e5)}).catch(s=>{o.error("[CACHE]",`Background refresh failed for memberId: ${t}:`,s)})):(o.info("[CACHE]",`Cache MISS - need to scrape for memberId: ${t}`),r=await K(t),n="MISS",o.info("[CACHE]",`Storing data in cache with TTL: ${3e5}ms for memberId: ${t}`),H(t,r,3e5),o.info("[CACHE]","Data stored successfully"))}return{data:r,cacheStatus:n}}export{$t as DEFAULT_MEMBER_ID,$ as buildMovemberUrl,B as detectSubdomainForMember,G as detectSubdomainFromHtml,q as extractAmounts,gt as extractRaisedAmount,x as extractSubdomainFromUrl,ft as extractTargetAmount,b as fetchViaProxy,Pt as getData,Q as getSubdomainForMember,Ct as scrapeMovemberPage,K as scrapeWithRetry};
//# sourceMappingURL=bundle.js.map
