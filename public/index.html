<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Movember Donation Tracker</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #e0e0e0;
      line-height: 1.6;
      padding: 0;
      min-height: 100vh;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 60px 20px;
    }
    header {
      text-align: center;
      margin-bottom: 60px;
    }
    h1 {
      font-size: 48px;
      font-weight: 700;
      color: #fff;
      margin-bottom: 16px;
      letter-spacing: -0.02em;
    }
    .subtitle {
      font-size: 20px;
      color: #b0b0b0;
      font-weight: 400;
      margin-bottom: 8px;
    }
    .description {
      font-size: 16px;
      color: #999;
      max-width: 600px;
      margin: 0 auto 40px;
    }
    section {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 32px;
      margin-bottom: 32px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    h2 {
      font-size: 28px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    h2::before {
      content: '';
      width: 4px;
      height: 28px;
      background: linear-gradient(180deg, #4CAF50 0%, #45a049 100%);
      border-radius: 2px;
    }
    h3 {
      font-size: 20px;
      font-weight: 600;
      color: #fff;
      margin-top: 24px;
      margin-bottom: 12px;
    }
    p {
      color: #ccc;
      margin-bottom: 16px;
      font-size: 16px;
    }
    .code-block {
      background: #0a0a0f;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 20px;
      margin: 16px 0;
      overflow-x: auto;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 14px;
      line-height: 1.5;
    }
    .code-block code {
      color: #4CAF50;
    }
    .url-example {
      background: #0a0a0f;
      border-left: 3px solid #4CAF50;
      padding: 12px 16px;
      margin: 12px 0;
      border-radius: 4px;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 14px;
      color: #fff;
      word-break: break-all;
    }
    .url-example .method {
      color: #4CAF50;
      font-weight: 600;
      margin-right: 8px;
    }
    ul {
      list-style: none;
      padding-left: 0;
    }
    li {
      color: #ccc;
      margin-bottom: 12px;
      padding-left: 24px;
      position: relative;
    }
    li::before {
      content: 'â†’';
      position: absolute;
      left: 0;
      color: #4CAF50;
      font-weight: bold;
    }
    .json-example {
      background: #0a0a0f;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 20px;
      margin: 16px 0;
      overflow-x: auto;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 14px;
      line-height: 1.5;
      color: #e0e0e0;
    }
    .json-key {
      color: #9cdcfe;
    }
    .json-string {
      color: #ce9178;
    }
    .json-number {
      color: #b5cea8;
    }
    .badge {
      display: inline-block;
      background: rgba(76, 175, 80, 0.2);
      color: #4CAF50;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 8px;
    }
    .note {
      background: rgba(255, 193, 7, 0.1);
      border-left: 3px solid #ffc107;
      padding: 12px 16px;
      margin: 16px 0;
      border-radius: 4px;
      color: #ffc107;
      font-size: 14px;
    }
    .data-display {
      background: rgba(76, 175, 80, 0.1);
      border-left: 3px solid #4CAF50;
      padding: 20px;
      margin: 20px 0;
      border-radius: 4px;
    }
    .data-display h3 {
      margin-top: 0;
      color: #4CAF50;
    }
    .data-item {
      margin: 12px 0;
      font-size: 18px;
    }
    .data-label {
      color: #aaa;
      font-weight: 500;
      margin-right: 8px;
    }
    .data-value {
      color: #fff;
      font-weight: 600;
    }
    .input-group {
      margin: 20px 0;
    }
    .input-group label {
      display: block;
      color: #ccc;
      margin-bottom: 8px;
      font-weight: 500;
    }
    .input-group input {
      width: 100%;
      padding: 12px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: #fff;
      font-size: 16px;
      font-family: inherit;
    }
    .input-group input:focus {
      outline: none;
      border-color: #4CAF50;
    }
    .button {
      background: linear-gradient(180deg, #4CAF50 0%, #45a049 100%);
      color: #fff;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .button:hover {
      opacity: 0.9;
    }
    .button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .loading {
      color: #4CAF50;
      font-style: italic;
    }
    .error {
      color: #ff4444;
      background: rgba(255, 68, 68, 0.1);
      border-left: 3px solid #ff4444;
      padding: 12px 16px;
      margin: 16px 0;
      border-radius: 4px;
    }
    @media (max-width: 768px) {
      h1 {
        font-size: 36px;
      }
      .subtitle {
        font-size: 18px;
      }
      section {
        padding: 24px;
      }
      .container {
        padding: 40px 16px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Movember Donation Tracker</h1>
      <p class="subtitle">API Documentation</p>
      <p class="description">
        Automatically track Movember donation progress. This service fetches and caches donation data from Movember pages, 
        providing it in a format perfect for stream overlays, websites, or other applications.
      </p>
    </header>

    <section>
      <h2>Live Data Display</h2>
      <div class="input-group">
        <label for="memberId">Member ID:</label>
        <input type="text" id="memberId" placeholder="Enter member ID (default: 14810348)" value="14810348">
      </div>
      <button class="button" id="fetchButton" onclick="fetchData()">Fetch Data</button>
      <button class="button" id="refreshButton" onclick="fetchData(true)" style="margin-left: 12px;">Force Refresh</button>
      <button class="button" id="copyOverlayButton" onclick="copyOverlayUrl()" style="margin-left: 12px;">Copy Overlay URL</button>
      <div id="dataDisplay"></div>
    </section>

    <section>
      <h2>What This Does</h2>
      <p>
        This client-side application automatically checks Movember donation pages and caches the current donation amount in your browser. 
        You can access this information through simple web links that return data in an easy-to-use format.
      </p>
      <p>
        The service handles multiple Movember members, automatically detects the correct subdomain (au.movember.com, fr.movember.com, etc.), 
        and caches results in localStorage for fast, efficient access.
      </p>
    </section>

    <section>
      <h2>JSON API Endpoint</h2>
      <p>Get donation data in JSON format:</p>
      <div class="url-example">
        <span class="method">GET</span><span id="baseUrl">/json</span>
      </div>
      
      <h3>Response Format</h3>
      <div class="json-example">
{<br>
&nbsp;&nbsp;<span class="json-key">"amount"</span>: <span class="json-string">"$2,500"</span>,<br>
&nbsp;&nbsp;<span class="json-key">"currency"</span>: <span class="json-string">"AUD"</span>,<br>
&nbsp;&nbsp;<span class="json-key">"target"</span>: <span class="json-string">"$10,000"</span>,<br>
&nbsp;&nbsp;<span class="json-key">"percentage"</span>: <span class="json-number">25</span>,<br>
&nbsp;&nbsp;<span class="json-key">"timestamp"</span>: <span class="json-number">1704067200000</span><br>
}
      </div>
    </section>

    <section>
      <h2>Overlay Endpoint</h2>
      <p>Get a visual progress bar overlay perfect for streaming or embedding:</p>
      <div class="url-example">
        <span class="method">GET</span><span id="overlayUrl">/overlay</span>
      </div>
      <p>
        The overlay displays the current donation amount, target, and a visual progress bar. 
        It automatically updates every 30 seconds and has a transparent background, making it perfect for OBS browser sources or stream overlays.
      </p>
    </section>

    <section>
      <h2>Using the memberId Parameter</h2>
      <p>
        Track any Movember member by adding the <code>memberId</code> query parameter to your URLs. 
        Each member ID has its own cache, so different members' data won't interfere with each other.
      </p>

      <h3>Finding Your Movember Member ID</h3>
      <ul>
        <li>Go to your Movember donation page (e.g., <code>https://au.movember.com/donate/details?memberId=YOUR_ID</code>)</li>
        <li>The number after <code>memberId=</code> in the URL is your member ID</li>
        <li>Use that ID in the query parameter when accessing the API</li>
      </ul>
    </section>

    <section>
      <h2>How It Works</h2>
      <ul>
        <li>The client-side JavaScript fetches Movember page HTML using the Worker's CORS proxy</li>
        <li>Parses the HTML using regex patterns to extract donation amounts</li>
        <li>Results are cached in localStorage for 5 minutes to avoid excessive requests</li>
        <li>Automatically detects the correct Movember subdomain</li>
        <li>Subdomain mappings are cached in localStorage for 24 hours for optimal performance</li>
      </ul>
    </section>
  </div>

  <script type="module">
    import { getData } from './js/movember-scraper.js';
    import { DEFAULT_MEMBER_ID } from './js/constants.js';

    // Set base URLs
    const baseUrl = window.location.origin;
    document.getElementById('baseUrl').textContent = baseUrl + '/json';
    document.getElementById('overlayUrl').textContent = baseUrl + '/overlay';

    // Get memberId from URL or use default
    function getMemberId() {
      const urlParams = new URLSearchParams(window.location.search);
      const memberId = urlParams.get('memberId') || urlParams.get('memberid') || 
                       document.getElementById('memberId').value || DEFAULT_MEMBER_ID;
      return memberId;
    }

    // Copy overlay URL to clipboard
    window.copyOverlayUrl = async function() {
      const memberId = getMemberId();
      const overlayUrl = `${baseUrl}/overlay?memberId=${memberId}`;
      const copyButton = document.getElementById('copyOverlayButton');
      const originalText = copyButton.textContent;

      try {
        await navigator.clipboard.writeText(overlayUrl);
        // Visual feedback: change button text temporarily
        copyButton.textContent = 'Copied!';
        setTimeout(() => {
          copyButton.textContent = originalText;
        }, 2000);
      } catch (error) {
        // Fallback for older browsers or if clipboard API fails
        try {
          // Create a temporary textarea element
          const textarea = document.createElement('textarea');
          textarea.value = overlayUrl;
          textarea.style.position = 'fixed';
          textarea.style.opacity = '0';
          document.body.appendChild(textarea);
          textarea.select();
          document.execCommand('copy');
          document.body.removeChild(textarea);
          
          // Visual feedback
          copyButton.textContent = 'Copied!';
          setTimeout(() => {
            copyButton.textContent = originalText;
          }, 2000);
        } catch (fallbackError) {
          // Show error message
          const displayDiv = document.getElementById('dataDisplay');
          displayDiv.innerHTML = `
            <div class="error">
              <strong>Error:</strong> Failed to copy URL to clipboard. URL: ${overlayUrl}
            </div>
          `;
        }
      }
    };

    // Fetch and display data
    window.fetchData = async function(forceRefresh = false) {
      const memberId = getMemberId();
      const displayDiv = document.getElementById('dataDisplay');
      const fetchButton = document.getElementById('fetchButton');
      const refreshButton = document.getElementById('refreshButton');
      const copyOverlayButton = document.getElementById('copyOverlayButton');

      // Update input field
      document.getElementById('memberId').value = memberId;

      // Disable buttons
      fetchButton.disabled = true;
      refreshButton.disabled = true;
      copyOverlayButton.disabled = true;
      displayDiv.innerHTML = '<div class="loading">Loading...</div>';

      try {
        const { data, cacheStatus } = await getData(memberId, forceRefresh);
        
        displayDiv.innerHTML = `
          <div class="data-display">
            <h3>Donation Data (${cacheStatus})</h3>
            <div class="data-item">
              <span class="data-label">Amount:</span>
              <span class="data-value">${data.amount || '$0'}</span>
            </div>
            ${data.target ? `
            <div class="data-item">
              <span class="data-label">Target:</span>
              <span class="data-value">${data.target}</span>
            </div>
            ` : ''}
            ${data.percentage !== undefined ? `
            <div class="data-item">
              <span class="data-label">Progress:</span>
              <span class="data-value">${data.percentage}%</span>
            </div>
            ` : ''}
            <div class="data-item">
              <span class="data-label">Currency:</span>
              <span class="data-value">${data.currency || 'AUD'}</span>
            </div>
            <div class="data-item">
              <span class="data-label">Last Updated:</span>
              <span class="data-value">${new Date(data.timestamp).toLocaleString()}</span>
            </div>
          </div>
        `;
      } catch (error) {
        displayDiv.innerHTML = `
          <div class="error">
            <strong>Error:</strong> ${error.message || 'Failed to fetch data'}
          </div>
        `;
      } finally {
        fetchButton.disabled = false;
        refreshButton.disabled = false;
        copyOverlayButton.disabled = false;
      }
    };

    // Auto-fetch on page load if memberId is in URL
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('memberId') || urlParams.has('memberid')) {
      window.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => window.fetchData(), 500);
      });
    }
  </script>
</body>
</html>

