var B={};var bt="https://{subdomain}.movember.com/donate/details",$t="https://{subdomain}.movember.com/team/{id}",Ot="14810348";var _=[1e3,2e3,4e3],vt={uk:"GBP",au:"AUD",us:"USD",ca:"CAD",nz:"NZD",ie:"EUR",za:"ZAR",nl:"EUR",de:"EUR",fr:"EUR",es:"EUR",it:"EUR",ex:"EUR",cz:"CZK",dk:"DKK",se:"SEK"};function Ct(t){return t&&vt[t.toLowerCase()]||"AUD"}var It={USD:"$",AUD:"$",CAD:"$",NZD:"$",GBP:"\xA3",EUR:"\u20AC",JPY:"\xA5",ZAR:"R",CZK:"K\u010D",DKK:"kr",SEK:"kr"};function at(t){return t&&It[t.toUpperCase()]||"$"}function Tt(){return`${window.location.origin}/proxy`}var x=t=>{let r=Math.round(t/1e3),e=Math.floor(r/60),n=r%60;return e>0?`${e}m ${n}s (${t}ms)`:`${r}s (${t}ms)`},ot=t=>new Promise(r=>setTimeout(r,t));var M={DEBUG:0,INFO:1,WARN:2,ERROR:3,NONE:4},K=M.INFO;function Ht(){try{let r=localStorage.getItem("LOG_LEVEL");if(r){let e=r.toUpperCase();if(e in M){K=M[e];return}}}catch(r){typeof console<"u"&&console.warn&&console.warn("[LOGGER] localStorage unavailable, using default log level:",r instanceof Error?r.message:String(r))}K=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"||window.location.search.includes("debug=true")?M.DEBUG:M.INFO}Ht();function Z(t,r,...e){return[`[${new Date().toISOString()}] [${t}] ${r}`,...e]}function W(t){return M[t]>=K}var m={setLevel(t){let r=t.toUpperCase();if(r in M){K=M[r];try{localStorage.setItem("LOG_LEVEL",r)}catch(e){try{m.warn("[LOGGER]","Failed to persist log level to localStorage:",e instanceof Error?e.message:String(e))}catch{typeof console<"u"&&console.warn&&console.warn("[LOGGER] Failed to persist log level:",e instanceof Error?e.message:String(e))}}}},getLevel(){for(let[t,r]of Object.entries(M))if(r===K)return t;return"INFO"},debug(t,...r){W("DEBUG")&&console.debug(...Z("DEBUG",t,...r))},info(t,...r){W("INFO")&&console.log(...Z("INFO",t,...r))},warn(t,...r){W("WARN")&&console.warn(...Z("WARN",t,...r))},error(t,...r){W("ERROR")&&console.error(...Z("ERROR",t,...r))}},i=m;var Y=(t,r)=>{let e=t.trim(),n=r?Ct(r):"AUD",a=e.replace(/[$€£¥]|\b(USD|EUR|GBP|AUD|JPY|CAD|NZD|ZAR)\b/gi,"").trim().match(/[\d,]+\.?\d*/);return{value:a?a[0]:"0",currency:n}},E=t=>{if(!t||typeof t!="string")return!1;let r=t.replace(/[,.\s$€£¥]/g,"");return!(!r||r.length===0||!/^\d+$/.test(r)||!/\d/.test(t)||/^[,.\s$€£¥]+$/.test(t))},it=(t,r)=>{let e=parseFloat(t.replace(/,/g,"")),n=parseFloat(r.replace(/,/g,""));return n===0?0:Math.round(e/n*100)};var Dt={SUBDOMAIN:/https?:\/\/([^.]+)\.movember\.com/},T=[/\bGBP\b[\s:]*[\d,]+|[\d,]+[\s:]*\bGBP\b|British\s+Pound/i,/\bEUR\b[\s:]*[\d,]+|[\d,]+[\s:]*\bEUR\b|Euro[\s:]*[\d,]+/i,/\bUSD\b[\s:]*[\d,]+|[\d,]+[\s:]*\bUSD\b|US\s+Dollar/i,/\bAUD\b[\s:]*[\d,]+|[\d,]+[\s:]*\bAUD\b|Australian\s+Dollar/i,/\bCAD\b[\s:]*[\d,]+|[\d,]+[\s:]*\bCAD\b|Canadian\s+Dollar/i,/\bNZD\b[\s:]*[\d,]+|[\d,]+[\s:]*\bNZD\b|New\s+Zealand\s+Dollar/i,/\bZAR\b[\s:]*[\d,]+|[\d,]+[\s:]*\bZAR\b|South\s+African\s+Rand/i,/\bCZK\b[\s:]*[\d,]+|[\d,]+[\s:]*\bCZK\b|Czech\s+Koruna|Kč[\d,]+/i,/\bSEK\b[\s:]*[\d,]+|[\d,]+[\s:]*\bSEK\b|Swedish\s+Krona/i,/\bDKK\b[\s:]*[\d,]+|[\d,]+[\s:]*\bDKK\b|Danish\s+Krone/i],b={IRELAND:/Ireland|Irish/i,NETHERLANDS:/Netherlands|Dutch/i,GERMANY:/Germany|German/i,FRANCE:/France|French/i,SPAIN:/Spain|Spanish/i,ITALY:/Italy|Italian/i,UNITED_STATES:/United\s+States|US\s+Dollar/i,CANADA:/Canada|Canadian/i,NEW_ZEALAND:/New\s+Zealand/i,AUSTRALIA:/Australia|Australian/i},yt=/\$[\d,]+/,st=[/"AmountRaised"[^}]*"(?:convertedAmount|originalAmount)"["\s:]*["']([\d,]+(?:\.\d+)?)/i,/donationProgress--amount__raised[^>]*>([^<]*\$([\d,]+(?:\.\d+)?)[^<]*)/i,/class="[^"]*donationProgress--amount__raised[^"]*"[^>]*>[\s\S]*?\$([\d,]+(?:\.\d+)?)/i,/"(?:raised|raisedAmount|currentAmount)"[:\s]*["']?\$?([\d,]+(?:\.\d+)?)/i,/data-(?:raised|amount)=["']?\$?([\d,]+(?:\.\d+)?)/i,/donationProgress--amount__raised[^>]*>([^<]*[€£$]([\d,]+(?:\.\d+)?)[^<]*)/i,/donationProgress--amount__raised[^>]*>([^<]*(?:USD|EUR|GBP|AUD)\s*([\d,]+(?:\.\d+)?)[^<]*)/i],ct=[/"target"[^}]*"fundraising"[^}]*"value"["\s:]*["']([\d,]+(?:\.\d+)?)/i,/donationProgress--amount__target[^>]*>([^<]*\$([\d,]+(?:\.\d+)?)[^<]*)/i,/class="[^"]*donationProgress--amount__target[^"]*"[^>]*>[\s\S]*?\$([\d,]+(?:\.\d+)?)/i,/"(?:target|targetAmount|goal)"[:\s]*["']?\$?([\d,]+(?:\.\d+)?)/i,/data-(?:target|goal)=["']?\$?([\d,]+(?:\.\d+)?)/i,/donationProgress--amount__target[^>]*>([^<]*[€£$]([\d,]+(?:\.\d+)?)[^<]*)/i,/donationProgress--amount__target[^>]*>([^<]*(?:USD|EUR|GBP|AUD)\s*([\d,]+(?:\.\d+)?)[^<]*)/i],V=[/"AmountRaised"[^}]*"(?:convertedAmount|originalAmount)"["\s:]*["']([\d,]+(?:\.\d+)?)/i,/"(?:raised|raisedAmount|currentAmount|donationAmount|amount)"[:\s]*["']?\$?([\d,]+(?:\.\d+)?)/i,/raised[:\s]*["']?\$?([\d,]+(?:\.\d+)?)/i],J=[/"target"[^}]*"fundraising"[^}]*"value"["\s:]*["']([\d,]+(?:\.\d+)?)/i,/"(?:target|targetAmount|goal)"[:\s]*["']?\$?([\d,]+(?:\.\d+)?)/i,/(?:target|goal)[:\s]*["']?\$?([\d,]+(?:\.\d+)?)/i],ut=[/\$([\d,]+(?:\.\d+)?)\s*(?:raised|donated|collected)/i,/(?:raised|donated|collected)[:\s]*\$([\d,]+(?:\.\d+)?)/i,/<[^>]+class="[^"]*(?:amount|raised|donation|progress)[^"]*"[^>]*>\s*\$?([\d,]+(?:\.\d+)?)/i,/data-[^=]*amount[^=]*=["']?\$?([\d,]+(?:\.\d+)?)/i,/\$([\d,]+(?:\.\d+)?)\s*(?:of|out of)/i,/raised[:\s=]+[$]?([\d,]+(?:\.\d+)?)/i,/amount[:\s=]+[$]?([\d,]+(?:\.\d+)?)/i],dt=[/\$([\d,]+(?:\.\d+)?)\s*(?:target|goal)/i,/(?:target|goal)[:\s]*\$([\d,]+(?:\.\d+)?)/i,/<[^>]+class="[^"]*(?:target|goal)[^"]*"[^>]*>\s*\$?([\d,]+(?:\.\d+)?)/i,/data-[^=]*(?:target|goal)[^=]*=["']?\$?([\d,]+(?:\.\d+)?)/i,/\$([\d,]+(?:\.\d+)?)\s*(?:of|out of)\s*\$([\d,]+(?:\.\d+)?)/i,/target[:\s=]+[$]?([\d,]+(?:\.\d+)?)/i,/goal[:\s=]+[$]?([\d,]+(?:\.\d+)?)/i];function Ft(t){try{let e=new DOMParser().parseFromString(t,"text/html"),n=["div.mospace-heroarea--donations-target-amount-wrapper > h1","div.mospace-heroarea--donations-target-amount-wrapper h1","span.donationProgress--amount__raised","span[class*='donationProgress--amount__raised']",".donationProgress--amount__raised",'[class*="donationProgress--amount__raised"]','[class*="raised"]',"[data-raised]","[data-amount]","[data-raised-amount]"];for(let a of n){let s=e.querySelectorAll(a);for(let c of Array.from(s)){let d=(c.textContent||c.innerText||"").match(/[\d,]+(?:\.\d+)?/);if(d&&E(d[0]))return m.info("[SCRAPE]",`Found raised amount using DOMParser with selector "${a}": ${d[0]}`),d[0];let u=c.getAttribute("data-raised")||c.getAttribute("data-amount")||c.getAttribute("data-raised-amount");if(u&&E(u))return m.info("[SCRAPE]",`Found raised amount using DOMParser data attribute: ${u}`),u}}let o=e.querySelectorAll("script");for(let a of Array.from(o)){let s=a.textContent||a.innerHTML||"";for(let c=0;c<V.length;c++){let f=V[c],d=s.match(f);if(d){let u=d[1];if(E(u))return m.info("[SCRAPE]",`Found raised amount in JSON using DOMParser: ${u}`),u}}}}catch(r){m.warn("[SCRAPE]","DOMParser extraction failed, falling back to regex:",r)}return""}function wt(t){let r=Ft(t);if(r)return r;m.info("[SCRAPE]","DOMParser didn't find raised amount, trying regex patterns..."),r="";for(let e=0;e<st.length;e++){let n=st[e],o=t.match(n);if(o){let a=o[o.length-1];if((!a||!E(a))&&o.length>2&&(a=o[o.length-2]),m.debug("[SCRAPE]",`Pattern ${e+1} matched, all groups:`,o.slice(1),`using: "${a}"`),E(a)){r=a,m.info("[SCRAPE]",`Found valid raised amount using pattern ${e+1}: ${r}`);break}else m.warn("[SCRAPE]",`Pattern ${e+1} matched but invalid number: "${a}", trying next pattern...`)}}if(!r){m.info("[SCRAPE]","Checking for JSON data in script tags...");let e=t.match(/<script[^>]*>([\s\S]*?)<\/script>/gi);if(e)for(let n of e){for(let o=0;o<V.length;o++){let a=V[o],s=n.match(a);if(s){let c=s[1];if(E(c)){r=c,m.info("[SCRAPE]",`Found valid raised amount in JSON using pattern ${o+1}: ${r}`);break}else m.warn("[SCRAPE]",`JSON raised pattern ${o+1} matched but invalid number: "${c}"`)}}if(r)break}}if(!r){m.info("[SCRAPE]","Trying generic dollar amount patterns as last resort...");for(let e=0;e<ut.length;e++){let n=ut[e],o=t.match(n);if(o){let a=o[1];if(E(a)){r=a,m.info("[SCRAPE]",`Found valid raised amount using generic pattern ${e+1}: ${r}`);break}else m.warn("[SCRAPE]",`Generic pattern ${e+1} matched but invalid number: "${a}"`)}}}if(!r){m.info("[SCRAPE]","Performing aggressive context-based search...");let e=[...t.matchAll(/\$([\d,]+(?:\.\d+)?)/g)];if(m.debug("[SCRAPE]",`Found ${e.length} dollar amounts in HTML`),e.length>0){let n=[];for(let o of e){let a=o[1];if(!E(a))continue;let s=o.index??0,c=Math.max(0,s-300),f=Math.min(t.length,s+o[0].length+300),d=t.substring(c,f).toLowerCase(),u=0;/(?:raised|donated|collected|current|funds?|progress|amount\s*(?:raised|donated))/i.test(d)&&(u+=10),/(?:has\s+raised|has\s+donated|has\s+collected|currently\s+raised)/i.test(d)&&(u+=5),/\$[\d,]+(?:\.\d+)?\s*(?:raised|donated|collected)/i.test(d)&&(u+=8),u>0&&n.push({amount:a,score:u,raisedScore:u,context:d.substring(0,200)})}if(n.sort((o,a)=>a.raisedScore-o.raisedScore),n.length>0){let o=n.filter(a=>a.raisedScore>0).sort((a,s)=>s.raisedScore-a.raisedScore);o.length>0&&(r=o[0].amount,m.info("[SCRAPE]",`Found raised amount via context search: ${r} (raisedScore: ${o[0].raisedScore})`))}}}return r}function kt(t){try{let e=new DOMParser().parseFromString(t,"text/html"),n=["#mospace-heroarea--donations-target-text",'[id*="mospace-heroarea--donations-target-text"]',"span.donationProgress--amount__target","span[class*='donationProgress--amount__target']",".donationProgress--amount__target",'[class*="donationProgress--amount__target"]','[class*="target"]','[class*="goal"]',"[data-target]","[data-goal]","[data-target-amount]"];for(let a of n){let s=e.querySelectorAll(a);for(let c of Array.from(s)){let d=(c.textContent||c.innerText||"").match(/[\d,]+(?:\.\d+)?/);if(d&&E(d[0]))return m.info("[SCRAPE]",`Found target amount using DOMParser with selector "${a}": ${d[0]}`),d[0];let u=c.getAttribute("data-target")||c.getAttribute("data-goal")||c.getAttribute("data-target-amount");if(u&&E(u))return m.info("[SCRAPE]",`Found target amount using DOMParser data attribute: ${u}`),u}}let o=e.querySelectorAll("script");for(let a of Array.from(o)){let s=a.textContent||a.innerHTML||"";for(let c=0;c<J.length;c++){let f=J[c],d=s.match(f);if(d){let u=d[1];if(E(u))return m.info("[SCRAPE]",`Found target amount in JSON using DOMParser: ${u}`),u}}}}catch(r){m.warn("[SCRAPE]","DOMParser extraction failed, falling back to regex:",r)}return""}function xt(t){let r=kt(t);if(r)return r;m.info("[SCRAPE]","DOMParser didn't find target amount, trying regex patterns..."),r="";for(let e=0;e<ct.length;e++){let n=ct[e],o=t.match(n);if(o){let a=o[o.length-1];if((!a||!E(a))&&o.length>2&&(a=o[o.length-2]),m.debug("[SCRAPE]",`Target pattern ${e+1} matched, all groups:`,o.slice(1),`using: "${a}"`),E(a)){r=a,m.info("[SCRAPE]",`Found valid target amount using pattern ${e+1}: ${r}`);break}else m.warn("[SCRAPE]",`Target pattern ${e+1} matched but invalid number: "${a}", trying next pattern...`)}}if(!r){let e=t.match(/<script[^>]*>([\s\S]*?)<\/script>/gi);if(e)for(let n of e){for(let o=0;o<J.length;o++){let a=J[o],s=n.match(a);if(s){let c=s[1];if(E(c)){r=c,m.info("[SCRAPE]",`Found valid target amount in JSON using pattern ${o+1}: ${r}`);break}else m.warn("[SCRAPE]",`JSON target pattern ${o+1} matched but invalid number: "${c}"`)}}if(r)break}}if(!r){m.info("[SCRAPE]","Trying generic target amount patterns as last resort...");for(let e=0;e<dt.length;e++){let n=dt[e],o=t.match(n);if(o){let a=null;for(let s=o.length-1;s>=1;s--)if(o[s]&&E(o[s])){a=o[s];break}if(a){r=a,m.info("[SCRAPE]",`Found valid target amount using generic pattern ${e+1}: ${r}`);break}else m.warn("[SCRAPE]",`Generic target pattern ${e+1} matched but no valid number found in capture groups`)}}}if(!r){let e=[...t.matchAll(/\$([\d,]+(?:\.\d+)?)/g)];if(e.length>0){let n=[];for(let o of e){let a=o[1];if(!E(a))continue;let s=o.index??0,c=Math.max(0,s-300),f=Math.min(t.length,s+o[0].length+300),d=t.substring(c,f).toLowerCase(),u=0;/(?:target|goal|aim|objective|of\s+\$)/i.test(d)&&(u+=10),/(?:target\s+(?:of|is)|goal\s+(?:of|is)|aim\s+(?:of|is))/i.test(d)&&(u+=5),/\$[\d,]+(?:\.\d+)?\s*(?:target|goal)/i.test(d)&&(u+=8),u>0&&n.push({amount:a,score:u,targetScore:u,context:d.substring(0,200)})}if(n.sort((o,a)=>a.targetScore-o.targetScore),n.length>0){let o=n.filter(a=>a.targetScore>0).sort((a,s)=>s.targetScore-a.targetScore);o.length>0&&(r=o[0].amount,m.info("[SCRAPE]",`Found target amount via context search: ${r} (targetScore: ${o[0].targetScore})`))}}}return r}function X(t,r,e){let n=Date.now();m.info("[SCRAPE]","Extracting data from HTML...");let o=wt(t),a=xt(t),s=Date.now()-n;return m.info("[SCRAPE]",`Data extraction completed in ${x(s)}`),m.debug("[SCRAPE]",`Raw extracted data for memberId ${r} (subdomain: ${e}):`,{raised:o||"NOT FOUND",target:a||"NOT FOUND"}),{raised:o,target:a}}var j={LOW:"low",MEDIUM:"medium",HIGH:"high",CRITICAL:"critical"},Q={SCRAPING:"scraping",SUBDOMAIN:"subdomain",CACHE:"cache",NETWORK:"network",PARSING:"parsing",VALIDATION:"validation",UNKNOWN:"unknown"},L={MAX_ERRORS:50,TTL_DAYS:7,MESSAGE_MAX_LENGTH:200,STACK_MAX_LENGTH:500},Gt=new Set(["token","access_token","refresh_token","api_key","apikey","password","secret","auth","authorization","session","sessionid","sid","csrf","csrf_token","email","user","username","memberid","member_id"]),Mt=new Set([]),Bt=[/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g,/\b(?:token|api[_-]?key|access[_-]?token|refresh[_-]?token|auth[_-]?token|bearer)\s*[:=]\s*['"]?([A-Za-z0-9\-._~+/]+=*)['"]?/gi,/\b(?:password|passwd|pwd|secret)\s*[:=]\s*['"]?([^\s'"]+)['"]?/gi,/\b\d{4}[\s-]?\d{4}[\s-]?\d{4}[\s-]?\d{4}\b/g];function q(t){if(!t)return"";let r=2166136261;for(let e=0;e<t.length;e++)r^=t.charCodeAt(e),r+=(r<<1)+(r<<4)+(r<<7)+(r<<8)+(r<<24);return`hash_${Math.abs(r).toString(16).substring(0,16)}`}function lt(t){let r=t;for(let e of Bt)r=r.replace(e,"[REDACTED]");return r}function Kt(t){let r=lt(t),e=r.length>L.MESSAGE_MAX_LENGTH?`${r.substring(0,L.MESSAGE_MAX_LENGTH)}...`:r,o=r!==t||e!==r?q(t):void 0;return{message:e,hash:o}}function Yt(t){if(!t)return{};let r=lt(t),e=r.length>L.STACK_MAX_LENGTH?`${r.substring(0,L.STACK_MAX_LENGTH)}...`:r,o=r!==t||e!==r?q(t):void 0;return{stack:e,hash:o}}function Vt(t){if(t)try{let r=new URL(t),e=r.origin,n=r.pathname;if(Mt.size===0)return`${e}${n}`;let o=new URLSearchParams;r.searchParams.forEach((s,c)=>{let f=c.toLowerCase();Mt.has(f)&&!Gt.has(f)&&o.set(c,s)});let a=o.toString();return a?`${e}${n}?${a}`:`${e}${n}`}catch{let e=t.split("#")[0].split("?")[0];try{let n=new URL(e);return`${n.origin}${n.pathname}`}catch{return"[INVALID_URL]"}}}function Jt(t){let r=Date.now();return t.filter(e=>{if(!e.expiresAt)return!0;try{return new Date(e.expiresAt).getTime()>r}catch{return!1}})}function zt(t){return t.length<=L.MAX_ERRORS?t:t.slice(-L.MAX_ERRORS)}function gt(t,r={}){let e=t instanceof Error?t.message:String(t),n=t instanceof Error?t.stack:void 0,{message:o,hash:a}=Kt(e),{stack:s,hash:c}=Yt(n),f=new Date,d=new Date(f.getTime()+L.TTL_DAYS*24*60*60*1e3),u={timestamp:f.toISOString(),expiresAt:d.toISOString(),message:o,...a&&{messageHash:a},...s&&{stack:s},...c&&{stackHash:c},category:r.category||Q.UNKNOWN,severity:r.severity||j.MEDIUM,context:{...r.memberId&&{memberId:q(r.memberId)},...r.subdomain&&{subdomain:q(r.subdomain)},...r.url&&{url:Vt(r.url)},...r.metadata&&Object.keys(r.metadata).length>0&&{metadata:Object.fromEntries(Object.entries(r.metadata).map(([l,p])=>[l,typeof p=="string"?lt(p):p]))}}};i.error("[ERROR_TRACKING]",`[${u.category}] [${u.severity}] ${e}`,u);try{let l=JSON.parse(localStorage.getItem("error_tracking_log")||"[]"),p=Jt(l);p.push(u);let $=zt(p);localStorage.setItem("error_tracking_log",JSON.stringify($))}catch(l){if(i?.warn)try{i.warn("[ERROR_TRACKING]","Failed to store error in localStorage (quota exceeded or unavailable):",l instanceof Error?l.message:String(l))}catch{}}return u}function mt(t,r={}){return gt(t,{category:Q.SCRAPING,severity:j.HIGH,...r})}function ft(t,r={}){return gt(t,{category:Q.SUBDOMAIN,severity:j.MEDIUM,...r})}function Pt(t,r={}){return gt(t,{category:Q.NETWORK,severity:j.HIGH,...r})}function P(t){let r=t.match(Dt.SUBDOMAIN);return r?r[1]:null}async function D(t){let r=`${Tt()}?url=${encodeURIComponent(t)}`,e=await fetch(r);if(!e.ok){let a=`Proxy error! status: ${e.status}`;try{if(e.headers.get("content-type")?.includes("application/json")){let f=await e.json();f.message&&(a=f.message)}else{let f=await e.text();f&&(a=f.substring(0,200))}}catch(c){i.warn("[PROXY]","Could not parse error response:",c)}let s=new Error(a);throw Pt(s,{url:t,metadata:{status:e.status,statusText:e.statusText}}),s}let n=await e.text(),o=e.headers.get("X-Final-URL")||t;return{html:n,finalUrl:o}}function O(t,r){return`${bt.replace("{subdomain}",r)}?memberId=${t}`}function I(t,r){return $t.replace("{subdomain}",r).replace("{id}",t)}function N(t,r,e){return`movember:${e}:${t}:${r}`}function Et(t,r){try{let e=N(t,r,"data"),n=localStorage.getItem(e);if(!n)return null;let o=JSON.parse(n);return Date.now()-o.cachedAt>o.ttl?(localStorage.removeItem(e),null):o.data}catch(e){return i.warn("[CACHE]","Error reading cached data:",e),null}}function St(t,r){try{let e=N(t,r,"data"),n=localStorage.getItem(e);return n?JSON.parse(n).data:null}catch(e){return i.warn("[CACHE]","Error reading stale cached data:",e),null}}function ht(t,r){try{let e=N(t,r,"data"),n=localStorage.getItem(e);if(!n)return!1;let o=JSON.parse(n);return Date.now()-o.cachedAt>o.ttl}catch(e){return i.warn("[CACHE]","Error checking if cached data is stale:",e),!1}}function v(t,r,e,n){try{let o=N(t,r,"data"),a={data:e,cachedAt:Date.now(),ttl:n};localStorage.setItem(o,JSON.stringify(a))}catch(o){i.warn("[CACHE]","Error setting cached data:",o)}}function pt(t,r){try{let e=N(t,r,"subdomain"),n=localStorage.getItem(e);if(!n)return null;let o=JSON.parse(n);return Date.now()-o.cachedAt>o.ttl?(localStorage.removeItem(e),null):o.subdomain}catch(e){return i.warn("[CACHE]","Error reading cached subdomain:",e),null}}function h(t,r,e,n){try{let o=N(t,r,"subdomain"),a={subdomain:e,cachedAt:Date.now(),ttl:n};localStorage.setItem(o,JSON.stringify(a))}catch(o){i.warn("[CACHE]","Error setting cached subdomain:",o)}}function z(t,r){try{let e=N(t,r,"data");localStorage.removeItem(e);let n=N(t,r,"subdomain");localStorage.removeItem(n);let o=`movember:amount:${t}:${r}`;localStorage.removeItem(o)}catch(e){i.warn("[CACHE]","Error clearing cached data:",e)}}function H(t){return t?t.includes("\xA3")||t.includes("&pound;")||t.includes("&#163;")?"uk":t.includes("\u20AC")||t.includes("&euro;")||t.includes("&#8364;")?t.match(b.IRELAND)?"ie":t.match(b.NETHERLANDS)?"nl":t.match(b.GERMANY)?"de":t.match(b.FRANCE)?"fr":t.match(b.SPAIN)?"es":t.match(b.ITALY)?"it":"ie":T[0].test(t)?"uk":T[1].test(t)?t.match(b.IRELAND)?"ie":t.match(b.NETHERLANDS)?"nl":t.match(b.GERMANY)?"de":t.match(b.FRANCE)?"fr":t.match(b.SPAIN)?"es":t.match(b.ITALY)?"it":"ie":T[2].test(t)?"us":T[3].test(t)?"au":T[4].test(t)?"ca":T[5].test(t)?"nz":T[6].test(t)?"za":T[7].test(t)?"cz":T[8].test(t)?"se":T[9].test(t)?"dk":yt.test(t)?t.match(b.UNITED_STATES)?"us":t.match(b.CANADA)?"ca":t.match(b.NEW_ZEALAND)?"nz":(t.match(b.AUSTRALIA),"au"):null:null}async function tt(t,r=!1){if(r)i.info("[SUBDOMAIN]",`Force refresh requested, skipping cache for memberId ${t}`);else{let n=pt("member",t);if(n)return i.info("[SUBDOMAIN]",`Found cached subdomain for memberId ${t}: ${n}`),n}if(B[t]){let n=B[t];return i.info("[SUBDOMAIN]",`Using manual override for memberId ${t}: ${n}`),h("member",t,n,864e5),n}i.info("[SUBDOMAIN]",`Detecting subdomain for memberId ${t}...`);let e=["au","uk","us","ca","nz","ie","za","nl","de","fr","es","it","cz","dk","se","ex"];try{let n=null;for(let a of e){let s=O(t,a);try{let{html:c,finalUrl:f}=await D(s),d=P(f);if(d&&d!==a)return i.info("[SUBDOMAIN]",`URL redirected from ${a} to ${d} for memberId ${t} (early exit)`),h("member",t,d,864e5),d;if(c&&c.length>1e3){let u=H(c);if(u===a||u===d){let l=d||a;return i.info("[SUBDOMAIN]",`Found matching subdomain for memberId ${t}: ${l} (verified by currency, early exit)`),h("member",t,l,864e5),l}else{if(u&&u!==a&&u!==d)return i.info("[SUBDOMAIN]",`HTML currency indicates ${u} (tested ${a}, final URL: ${d||a}), using detected subdomain (early exit)`),h("member",t,u,864e5),u;{let l=d||a;n||(n=l,i.info("[SUBDOMAIN]",`Found valid HTML for subdomain ${l} (currency check inconclusive, storing as fallback)`))}}}}catch(c){let f=c instanceof Error?c:new Error(String(c));f.message&&!f.message.includes("404")&&i.warn("[SUBDOMAIN]",`Error trying subdomain ${a}:`,c)}}if(n)return i.info("[SUBDOMAIN]",`Using fallback subdomain for memberId ${t}: ${n} (no currency match found)`),h("member",t,n,864e5),n;let o=O(t,"au");try{let{html:a,finalUrl:s}=await D(o);if(a&&a.length>1e3){let c=P(s)||"au";return i.info("[SUBDOMAIN]",`Using default subdomain for memberId ${t}: ${c}`),h("member",t,c,864e5),c}}catch(a){i.warn("[SUBDOMAIN]","Error trying default subdomain:",a)}return i.warn("[SUBDOMAIN]",`Could not find working subdomain for memberId ${t}, using default: ${"au"}`),h("member",t,"au",864e5),"au"}catch(n){return ft(n instanceof Error?n:new Error(String(n)),{memberId:t,metadata:{timestamp:Date.now()}}),i.warn("[SUBDOMAIN]",`Failed to detect subdomain for memberId ${t}, using default:`,n),h("member",t,"au",864e5),"au"}}async function At(t){return B[t]?B[t]:await tt(t)}async function Rt(t,r=!1){if(r)i.info("[SUBDOMAIN]",`Force refresh requested, skipping cache for teamId ${t}`);else{let n=pt("team",t);if(n)return i.info("[SUBDOMAIN]",`Found cached subdomain for teamId ${t}: ${n}`),n}i.info("[SUBDOMAIN]",`Detecting subdomain for teamId ${t}...`);let e=["au","uk","us","ca","nz","ie","za","nl","de","fr","es","it","cz","dk","se","ex"];try{let n=null;for(let a of e){let s=I(t,a);try{let{html:c,finalUrl:f}=await D(s),d=P(f);if(d&&d!==a)return i.info("[SUBDOMAIN]",`URL redirected from ${a} to ${d} for teamId ${t} (early exit)`),h("team",t,d,864e5),d;if(c&&c.length>1e3){let u=H(c);if(u===a||u===d){let l=d||a;return i.info("[SUBDOMAIN]",`Found matching subdomain for teamId ${t}: ${l} (verified by currency, early exit)`),h("team",t,l,864e5),l}else{if(u&&u!==a&&u!==d)return i.info("[SUBDOMAIN]",`HTML currency indicates ${u} (tested ${a}, final URL: ${d||a}), using detected subdomain (early exit)`),h("team",t,u,864e5),u;{let l=d||a;n||(n=l,i.info("[SUBDOMAIN]",`Found valid HTML for subdomain ${l} (currency check inconclusive, storing as fallback)`))}}}}catch(c){let f=c instanceof Error?c:new Error(String(c));f.message&&!f.message.includes("404")&&i.warn("[SUBDOMAIN]",`Error trying subdomain ${a}:`,c)}}if(n)return i.info("[SUBDOMAIN]",`Using fallback subdomain for teamId ${t}: ${n} (no currency match found)`),h("team",t,n,864e5),n;let o=I(t,"au");try{let{html:a,finalUrl:s}=await D(o);if(a&&a.length>1e3){let c=P(s)||"au";return i.info("[SUBDOMAIN]",`Using default subdomain for teamId ${t}: ${c}`),h("team",t,c,864e5),c}}catch(a){i.warn("[SUBDOMAIN]","Error trying default subdomain:",a)}return i.warn("[SUBDOMAIN]",`Could not find working subdomain for teamId ${t}, using default: ${"au"}`),h("team",t,"au",864e5),"au"}catch(n){return ft(n instanceof Error?n:new Error(String(n)),{memberId:t,metadata:{timestamp:Date.now()}}),i.warn("[SUBDOMAIN]",`Failed to detect subdomain for teamId ${t}, using default:`,n),h("team",t,"au",864e5),"au"}}async function Nt(t){return await Rt(t)}async function Ut(t,r=!1){let e=await At(t),n=O(t,e),o=Date.now();i.info("[SCRAPE]",`Starting scrape of Movember page: ${n} (subdomain: ${e})`);try{i.info("[SCRAPE]",`Fetching HTML from ${n} via proxy...`);let a=Date.now(),s,c;try{let g=await D(n);s=g.html,c=g.finalUrl}catch(g){if(r&&g instanceof Error&&g.message.includes("404")){i.warn("[SCRAPE]",`Got 404 for ${n}, clearing cached subdomain and re-detecting...`),z("member",t);let S=await tt(t,!0);if(S!==e){i.info("[SCRAPE]",`Re-detected subdomain: ${S} (was ${e}), retrying with new subdomain...`);let U=O(t,S),G=await D(U);s=G.html,c=G.finalUrl,e=S}else throw new Error("HTTP error! status: 404 (page not found - member may not exist)")}else throw g}let f=Date.now()-a;i.info("[SCRAPE]",`HTML fetched successfully in ${x(f)} (${s.length} characters)`);let d=P(c);d&&d!==e&&(i.info("[SCRAPE]",`URL redirected from ${e} to ${d}, updating subdomain...`),e=d,h("member",t,e,864e5));let u=H(s);u&&u!==e?i.warn("[SCRAPE]",`HTML currency indicates subdomain ${u} but URL subdomain is ${e}. Trusting URL subdomain (primary source).`):u===e&&i.info("[SCRAPE]",`HTML currency verification confirms subdomain ${e}`);let{raised:l,target:p}=X(s,t,e);if(!l||!E(l)){let g=s.match(/\$[\d,]+(?:\.\d+)?/g);i.warn("[SCRAPE]",`Found ${g?g.length:0} dollar amounts in HTML:`,g?g.slice(0,10):[]);let S=s.match(/[\d,]{3,}(?:\.\d+)?/g);i.warn("[SCRAPE]",`Found ${S?S.length:0} potential amount numbers in HTML (showing first 20):`,S?S.slice(0,20):[]);let U={memberId:t,subdomain:e,url:n,message:"Could not find raised amount in HTML. The page may require JavaScript execution or the HTML structure may have changed.",htmlLength:s.length,dollarAmountsFound:g?g.length:0,raisedValue:l||"empty"};throw i.error("[SCRAPE]","Failed to extract raised amount:",U),new Error(`Could not find raised amount in HTML for memberId ${t} (subdomain: ${e}). The page may require JavaScript execution or the HTML structure may have changed. Found ${g?g.length:0} dollar amounts in HTML.`)}if(!E(l))throw new Error(`Invalid raised value captured: "${l}" for memberId ${t}`);let{value:$,currency:F}=Y(`$${l}`,e);(!$||$==="0"||$==="")&&i.warn("[SCRAPE]",`Parsed raised value is invalid: "${$}" from input: "${l}"`);let k=at(F),R={amount:`${k}${$}`,currency:F,subdomain:e,timestamp:Date.now()};if(p&&E(p)){let{value:g}=Y(`$${p}`,e),S=`${k}${g}`;R.target=S,R.percentage=it($,g)}else p&&i.warn("[SCRAPE]",`Target value "${p}" failed validation, skipping target`);let nt=Date.now()-o;return i.info("[SCRAPE]",`Scraping completed successfully in ${x(nt)}:`,{amount:R.amount,target:R.target,percentage:R.percentage,currency:R.currency,subdomain:R.subdomain}),R}catch(a){let s=Date.now()-o,c=a instanceof Error?a.message:String(a);throw mt(a instanceof Error?a:new Error(c),{memberId:t,subdomain:e,url:n,metadata:{duration:s,timestamp:Date.now()}}),i.error("[SCRAPE]",`Scraping failed after ${x(s)}:`,c,a),a}}async function et(t){let r=null,e=Date.now();i.info("[RETRY]",`Starting retry logic (max ${3} attempts) for memberId: ${t}`);for(let n=0;n<3;n++)try{i.info("[RETRY]",`Attempt ${n+1}/${3}`);let o=n===0||r?.message.includes("404"),a=await Ut(t,o),s=Date.now()-e;return i.info("[RETRY]",`Success on attempt ${n+1} after ${s}ms`),a}catch(o){r=o instanceof Error?o:new Error(String(o));let a=r.message;if(i.error("[RETRY]",`Attempt ${n+1} failed:`,a),a.includes("404")&&(i.info("[RETRY]",`404 detected, clearing subdomain cache for memberId: ${t}`),z("member",t)),n<2){let s=_[n]||_[_.length-1];i.info("[RETRY]",`Waiting ${s}ms before retry ${n+2}...`),await ot(s)}else{let s=Date.now()-e;i.error("[RETRY]",`All ${3} attempts failed after ${s}ms`)}}throw r||new Error("Failed to scrape after all retries")}async function Zt(t,r=!1){let e=null,n="HIT";if(r)i.info("[LIVE]",`grab-live parameter detected - forcing fresh scrape for memberId: ${t}`),e=await et(t),n="LIVE",i.info("[CACHE]",`Storing live data in cache with TTL: ${3e5}ms for memberId: ${t}`),v("member",t,e,3e5),i.info("[CACHE]","Live data stored successfully");else if(i.info("[CACHE]",`Checking cache for memberId: ${t}`),e=Et("member",t),e){let o=Date.now()-e.timestamp;i.info("[CACHE]",`Cache HIT - data age: ${Math.round(o/1e3)}s for memberId: ${t}`,{amount:e.amount,target:e.target,timestamp:new Date(e.timestamp).toISOString()})}else{let o=St("member",t),a=ht("member",t);o&&a?(i.info("[CACHE]",`Cache STALE - returning stale data immediately, fetching fresh data in background for memberId: ${t}`),e=o,n="STALE",et(t).then(s=>{i.info("[CACHE]",`Background refresh completed for memberId: ${t}, updating cache`),v("member",t,s,3e5)}).catch(s=>{i.error("[CACHE]",`Background refresh failed for memberId: ${t}:`,s)})):(i.info("[CACHE]",`Cache MISS - need to scrape for memberId: ${t}`),e=await et(t),n="MISS",i.info("[CACHE]",`Storing data in cache with TTL: ${3e5}ms for memberId: ${t}`),v("member",t,e,3e5),i.info("[CACHE]","Data stored successfully"))}if(!e)throw new Error(`Unexpected null data for memberId: ${t}. This should never happen.`);return{data:e,cacheStatus:n}}async function _t(t,r=!1){let e=await Nt(t),n=I(t,e),o=Date.now();i.info("[SCRAPE]",`Starting scrape of Movember team page: ${n} (subdomain: ${e})`);try{i.info("[SCRAPE]",`Fetching HTML from ${n} via proxy...`);let a=Date.now(),s,c;try{let g=await D(n);s=g.html,c=g.finalUrl}catch(g){if(r&&g instanceof Error&&g.message.includes("404")){i.warn("[SCRAPE]",`Got 404 for ${n}, clearing cached subdomain and re-detecting...`),z("team",t);let S=await Rt(t,!0);if(S!==e){i.info("[SCRAPE]",`Re-detected subdomain: ${S} (was ${e}), retrying with new subdomain...`);let U=I(t,S),G=await D(U);s=G.html,c=G.finalUrl,e=S}else throw new Error("HTTP error! status: 404 (page not found - team may not exist)")}else throw g}let f=Date.now()-a;i.info("[SCRAPE]",`HTML fetched successfully in ${x(f)} (${s.length} characters)`);let d=P(c);d&&d!==e&&(i.info("[SCRAPE]",`URL redirected from ${e} to ${d}, updating subdomain...`),e=d,h("team",t,e,864e5));let u=H(s);u&&u!==e?i.warn("[SCRAPE]",`HTML currency indicates subdomain ${u} but URL subdomain is ${e}. Trusting URL subdomain (primary source).`):u===e&&i.info("[SCRAPE]",`HTML currency verification confirms subdomain ${e}`);let{raised:l,target:p}=X(s,t,e);if(!l||!E(l)){let g=s.match(/\$[\d,]+(?:\.\d+)?/g);i.warn("[SCRAPE]",`Found ${g?g.length:0} dollar amounts in HTML:`,g?g.slice(0,10):[]);let S=s.match(/[\d,]{3,}(?:\.\d+)?/g);i.warn("[SCRAPE]",`Found ${S?S.length:0} potential amount numbers in HTML (showing first 20):`,S?S.slice(0,20):[]);let U={teamId:t,subdomain:e,url:n,message:"Could not find raised amount in HTML. The page may require JavaScript execution or the HTML structure may have changed.",htmlLength:s.length,dollarAmountsFound:g?g.length:0,raisedValue:l||"empty"};throw i.error("[SCRAPE]","Failed to extract raised amount:",U),new Error(`Could not find raised amount in HTML for teamId ${t} (subdomain: ${e}). The page may require JavaScript execution or the HTML structure may have changed. Found ${g?g.length:0} dollar amounts in HTML.`)}if(!E(l))throw new Error(`Invalid raised value captured: "${l}" for teamId ${t}`);let{value:$,currency:F}=Y(`$${l}`,e);(!$||$==="0"||$==="")&&i.warn("[SCRAPE]",`Parsed raised value is invalid: "${$}" from input: "${l}"`);let k=at(F),R={amount:`${k}${$}`,currency:F,subdomain:e,timestamp:Date.now()};if(p&&E(p)){let{value:g}=Y(`$${p}`,e),S=`${k}${g}`;R.target=S,R.percentage=it($,g)}else p&&i.warn("[SCRAPE]",`Target value "${p}" failed validation, skipping target`);let nt=Date.now()-o;return i.info("[SCRAPE]",`Scraping completed successfully in ${x(nt)}:`,{amount:R.amount,target:R.target,percentage:R.percentage,currency:R.currency,subdomain:R.subdomain}),R}catch(a){let s=Date.now()-o,c=a instanceof Error?a.message:String(a);throw mt(a instanceof Error?a:new Error(c),{memberId:t,subdomain:e,url:n,metadata:{duration:s,timestamp:Date.now()}}),i.error("[SCRAPE]",`Scraping failed after ${x(s)}:`,c,a),a}}async function rt(t){let r=null,e=Date.now();i.info("[RETRY]",`Starting retry logic (max ${3} attempts) for teamId: ${t}`);for(let n=0;n<3;n++)try{i.info("[RETRY]",`Attempt ${n+1}/${3}`);let o=n===0||r?.message.includes("404"),a=await _t(t,o),s=Date.now()-e;return i.info("[RETRY]",`Success on attempt ${n+1} after ${s}ms`),a}catch(o){r=o instanceof Error?o:new Error(String(o));let a=r.message;if(i.error("[RETRY]",`Attempt ${n+1} failed:`,a),a.includes("404")&&(i.info("[RETRY]",`404 detected, clearing subdomain cache for teamId: ${t}`),z("team",t)),n<2){let s=_[n]||_[_.length-1];i.info("[RETRY]",`Waiting ${s}ms before retry ${n+2}...`),await ot(s)}else{let s=Date.now()-e;i.error("[RETRY]",`All ${3} attempts failed after ${s}ms`)}}throw r||new Error("Failed to scrape after all retries")}async function Wt(t,r=!1){let e=null,n="HIT";if(r)i.info("[LIVE]",`grab-live parameter detected - forcing fresh scrape for teamId: ${t}`),e=await rt(t),n="LIVE",i.info("[CACHE]",`Storing live data in cache with TTL: ${3e5}ms for teamId: ${t}`),v("team",t,e,3e5),i.info("[CACHE]","Live data stored successfully");else if(i.info("[CACHE]",`Checking cache for teamId: ${t}`),e=Et("team",t),e){let o=Date.now()-e.timestamp;i.info("[CACHE]",`Cache HIT - data age: ${Math.round(o/1e3)}s for teamId: ${t}`,{amount:e.amount,target:e.target,timestamp:new Date(e.timestamp).toISOString()})}else{let o=St("team",t),a=ht("team",t);o&&a?(i.info("[CACHE]",`Cache STALE - returning stale data immediately, fetching fresh data in background for teamId: ${t}`),e=o,n="STALE",rt(t).then(s=>{i.info("[CACHE]",`Background refresh completed for teamId: ${t}, updating cache`),v("team",t,s,3e5)}).catch(s=>{i.error("[CACHE]",`Background refresh failed for teamId: ${t}:`,s)})):(i.info("[CACHE]",`Cache MISS - need to scrape for teamId: ${t}`),e=await rt(t),n="MISS",i.info("[CACHE]",`Storing data in cache with TTL: ${3e5}ms for teamId: ${t}`),v("team",t,e,3e5),i.info("[CACHE]","Data stored successfully"))}if(!e)throw new Error(`Unexpected null data for teamId: ${t}. This should never happen.`);return{data:e,cacheStatus:n}}export{Ot as DEFAULT_MEMBER_ID,O as buildMovemberUrl,tt as detectSubdomainForMember,H as detectSubdomainFromHtml,X as extractAmounts,wt as extractRaisedAmount,P as extractSubdomainFromUrl,xt as extractTargetAmount,D as fetchViaProxy,Zt as getData,At as getSubdomainForMember,Wt as getTeamData,Ut as scrapeMovemberPage,_t as scrapeTeamPage,rt as scrapeTeamWithRetry,et as scrapeWithRetry};
//# sourceMappingURL=bundle.js.map
